= BPM Concepts

In the following section, we will explore key concepts essential to understanding the Flowable process engine.
These concepts include process models, process definitions, executions, process instances, deployments, tokens, and the process context.
Each of these elements plays a vital role in how the Flowable engine operates, facilitating the execution and management of business processes.

[[process-engine]]
== Process Engine

The Flowable *process engine* in Flowable is a core component responsible for managing and executing business processes defined in BPMN.
It provides the necessary infrastructure to deploy, start, and control process instances, ensuring that business workflows are executed according to defined rules and logic.
You can access process engine via xref:bpm:jmix-bpm-api.adoc#flowable-api[Flowable API].

[[job-executor]]
== Job Executor

The Flowable *Job Executor* is a key component responsible for managing and executing asynchronous jobs within the Flowable process engine.
It handles tasks such as timers, asynchronous continuations, and other background processes that need to be executed outside the main process flow.
By offloading these tasks, the job executor ensures that the main execution thread remains responsive and efficient.

The job executor operates in a multithreaded environment, allowing it to process multiple jobs concurrently.
It retrieves jobs from the database, executes them, and updates their status accordingly.
This mechanism is essential for implementing features like delayed tasks and scheduled events in business processes.

Overall, the Flowable Job Executor enhances the performance and scalability of the process engine by efficiently managing background jobs and ensuring smooth process execution.

[[process-arifacts]]
== Process Artifacts

During the process lifecycle, various artifacts are created.
Understanding these artifacts is crucial for effectively managing and implementing business processes.

In the picture below, you can see how these artifacts are related. In the beginning, the user creates a <<process-models,process model>> represented by an XML file.
Usually, one file contains one process model. However, in the case of a <<collaboration-model,collaboration model>>, there could be several process models in one XML file.

Next, processes must be deployed to the server. This happens in two steps: first, the <<deployments,deployment>> object is created.
It is essentially a batch that can contain several process models implemented in one action. Second, for each process model in the deployment, a <<process-definitions,process definition>> is created.

Further, to start a process, the server creates the <<process-instances,process instance>> object.
At runtime, for certain branches (or paths) of the process, <<executions,execution>> objects can be created.

In the end, the process instance is transformed into a <<historic-process-instances,historic process instance>>.

image::modeling-and-execution/process-artifacts.png[,900]

Below, there is a detailed description of mentioned artifacts:

[[process-models]]
=== Process Models

In Jmix BPM, a *process model* refers to the structured representation of a business process, defined in an XML format using the BPMN 2.0 standard.
The structure of a BPMN process model consists of several key sections that together describe the behavior and flow of the business process.

The `<definitions>` section serves as the root element of the BPMN XML file.
It encapsulates the entire process model and provides context for the various components defined within it.
This section typically includes metadata about the model, such as the XML namespace and the schema location, which ensures that the document adheres to BPMN standards.

Within the `<definitions>` section, you will find either a `<process>` or a `<collaboration>` element.
The `<process>` element defines a single xref:bpmn/bpmn-process.adoc[process] with its associated activities, events, and gateways.
This is the most common structure used when modeling a straightforward business process.

On the other hand, the [[collaboration-model]]`<collaboration>` element is used when multiple processes interact with each other, allowing for a more complex representation of workflows involving different participants or entities.
In this case, a xref:bpmn/bpmn-collaboration.adoc[collaboration] model is created.

The model also includes xref:bpmn/bpmn-events.adoc#event-definitions[event definitions] for *messages*, *signals*, and *errors*.

Finally, the `<diagram>` section provides a visual representation of the process model, typically using a graphical notation.
This section is useful for human readers and process designers, as it allows them to visualize the flow and structure of the process.
Although the diagram does not affect the execution of the process, it enhances understanding and communication among stakeholders.

Here is an example of the visual process model in BPMN 2.0 notation and its XML representation:

image::process-example.png[,800]

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" <!--Other namespases.... --> >

  <!--Process definition-->
  <process id="document-approval" name="Document approval" isExecutable="true">
     <!--Process elements-->
  <process/>

  <!--Event definitions-->
  <message id="start-approval-process" name="Start approval process" />
  <signal id="payment-failed" name="Payment failed" flowable:scope="global" />
  <error id="payment-serice-error" name="Payment serice error" errorCode="900" />

  <!--Diagram section-->
  <bpmndi:BPMNDiagram id="BPMNDiagram_process">
      <!-- Diagram elements -->
  <bpmndi:BPMNDiagram/>
</definitions>
----

==== Storing Process Models

Typically in *Studio*, process models are stored in `src/main/resources/process-drafts` directory for drafts and in `src/main/resources/processes` for processes ready for deployment.

Actually, you can store process XML files anywhere you want, but we recommend to use default locations.
In this case, *Studio* will be able to provide advanced features for managing process models.
See the xref:modeler-studio.adoc[Studio Modeler] description.


[[deployments]]
=== Deployments

In Flowable, a *deployment* object serves as a container for various resources related to business processes, such as BPMN process models, images, forms, and other artifacts.

[NOTE]
====
In *Studio*, processes are deployed automatically, see xref:bpm:auto-deployment.adoc[] section for details.
Or deploy them using _Hot deploy_ feature in *Studio*.

As well, you can deploy processes manually from xref:bpm:menu-views/modeler-web.adoc[Web Modeler].
====

Deployments are created using the `DeploymentBuilder` interface through `RepositoryService`.
The resources are added to the deployment using methods such as `addClasspathResource`, `addInputStream`, or other methods.
Once all resources are included, the deployment is finalized with the `deploy()` method:

[source,java]
----
repositoryService.createDeployment()
        .name("My Deployment")
        .addClasspathResource("processes/my-process.bpmn") <1>
        .addString("greeting", "Hello, world!") <2>
        .deploy();
----
<1> -- Adding a BPMN process model as an XML file.
<2> -- Adding a resource as a string.

Once a deployment is completed, the deployment object becomes read-only.
This means that its contents cannot be changed after deployment, ensuring the integrity of the deployed resources.

Upon deployment, Flowable parses the BPMN XML files included in the deployment.
For each BPMN file parsed, Flowable creates one or more process definitions.
Each process definition is an internal representation of the process defined in the BPMN XML.

==== Accessing Deployed Resources
To access deployed resources at runtime:

[source,java]
----
//List the resources in the deployment:
List<String> resourceNames = repositoryService.getDeploymentResourceNames(deploymentId);

//Retrieve a specific resource:
InputStream resourceStream = repositoryService.getResourceAsStream(deploymentId, "my-resource.txt");
----

[[deleting-deployments]]
==== Deleting Deployments

To delete a deployment in Flowable, you can use the `RepositoryService` to remove the deployment object.

[source,java]
----
// Specify the deployment ID you want to delete
String deploymentId = "yourDeploymentId";
// Replace with your actual deployment ID

// Delete the deployment
repositoryService.deleteDeployment(deploymentId, true); // The second parameter indicates whether to cascade delete process instances
----

The first parameter is the deployment ID, which you can obtain when you create a deployment or by querying existing deployments.

The second parameter (`true` or `false`) determines whether to cascade the deletion to all process instances associated with that deployment.
If set to `true`, all active and historic process instances created from this deployment will also be deleted.

If cascade deletion is set to `false`, any active or historic process instances created from the processes defined in that deployment will not be deleted.
This means that while the process definitions are no longer available for new instances, the existing instances remain intact in the system.

[CAUTION]
====
You can delete a certain deployment manually in the _Process Definition Detail_ view.
But keep in mind that this operation deletes _ALL_ process definitions deployed together.
====

==== Storing Deployments
The created process definitions are stored in the Flowable database, specifically in table `ACT_RE_DEPLOYMENT`.

==== Properties
A *deployment* has the following properties:

[cols="1,2", options="header"]
|===
| Property | Description

| Id
| A unique identifier for the deployment.

| Name
| A descriptive name for the deployment, helping to identify it among multiple deployments.

| Deployment Time
| The timestamp indicating when the deployment was created.

| Resources
| A collection of resources (e.g., BPMN files, DMN tables) included in the deployment.

| Version
| The version number of the deployment, helping manage updates and changes to process definitions over time.
|===

[[process-definitions]]
=== Process Definitions

A *process definition* object represents a blueprint for an executable business process.
It encapsulates the structure, activities, and logic of a process, allowing the <<process-engine,process engine>> to manage and execute <<process-instances,process instances>> based on the defined <<process-models,process model>>.

Each *process definition* is associated with a specific <<deployments,deployment>>, which acts as a container for one or more process definitions and related resources.
The deployment ID can be retrieved using the `getDeploymentId()` method.

To access process definitions, deployed to the engine, use *BPM* -> xref:menu-views/process-definitions.adoc[Process definitions view].

==== Suspending and Activating

Process definition has two states: *active* and *suspended*.

* *Active state*: In this state, the definition can be used to create and execute processes based on its defined structure.

* *Suspended State*: In this state, no new instances can be started from this definition, but existing instances that were already running can continue until they complete or are terminated.

Transition Between States:

[source,java]
----
// Suspending a process definition
repositoryService.suspendProcessDefinitionByKey(processDefinitionKey);

// Activating a suspended process definition
repositoryService.activateProcessDefinitionByKey(processDefinitionKey);
----

As well, you can suspend and activate proces definition by ID.


==== Versioning

Process definitions are versioned, allowing multiple versions of the same process to exist simultaneously.
Each time a new version is deployed, it increments the version number, enabling users to start instances from different versions as needed.

==== Accessing Process Definitions
To access process definitions at runtime:

[source,java]
----
// Querying for all process definitions in deployment
List<ProcessDefinition> processDefinitions = repositoryService.createProcessDefinitionQuery()
    .deploymentId(deploymentId)
    .list();

// Querying for all versions of the process definition
repositoryService.createProcessDefinitionQuery()
        .processDefinitionKey(key)
        .list();

// Querying for the latest version of the process definition
 ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery()
        .processDefinitionKey(key)
        .latestVersion()
        .singleResult();
----

==== Deleting Process Definition

It's impossible to delete the specific process definition.
You have to delete the associated deployment object.
See <<deleting-deployments>> section.

==== Storing Process Definitions
The created process definitions are stored in the  database, specifically in table `ACT_RE_PROCDEF`.

==== Properties
A process definition in Flowable has several important properties:

[cols="1,2", options="header"]
|===
| Attribute | Description

| ID
| A unique identifier for the process definition.

| Key
| A key that uniquely identifies the process definition across versions. (Important: In the process model this parameter is called `process ID`.)

| Name
| A descriptive name for the process definition.

| Version
| The version number of the process definition.

| Deployment ID
| The deployment, this process definition belongs to.

| Resource Name
| The name of the BPMN XML file that defines the process.
|===


[[process-instances]]
=== Process Instances

In Flowable, a *process instance* represents a running instance of a business process. It encapsulates the execution of a specific <<process-definitions,process definition>>, with its own state and data.

==== Creating a Process Instance

[source,java]
----
// Example variable for the process
Map<String, Object> variables = new HashMap<>();
variables.put("employeeId", "12345");

ProcessInstance processInstance = runtimeService.startProcessInstanceByKey("my-process", variables);
----

[source,java]
----
ProcessInstanceBuilder builder = runtimeService.createProcessInstanceBuilder()
    .processDefinitionKey("myProcess")
    .businessKey("holidayRequest-123")
    .variable("employeeId", "12345")
    .start();

ProcessInstance processInstance = builder.start();
----





==== Process Instance Lifecycle


==== Accessing Process Instances

==== Storing Process Instances

Flowable stores process instances together with *executions* in the table named `ACT_RU_EXECUTION`.

==== Properties

[cols="1,2", options="header"]
|===
| Property | Description

| ID
| A unique identifier for the process instance.

| Business Key
| An optional business-level identifier for the process instance.

| Process Definition ID
| The ID of the process definition that the instance is based on.

| Start Time
| The timestamp when the process instance was started.

| End Time
| The timestamp when the process instance was completed (if applicable).

| Duration
| The duration of the process instance execution.

| State
| The current state of the process instance (e.g., running, suspended, completed).

| Variables
| The data variables associated with the process instance.
|===




[[business-key]]
==== Business Key
A business key is a way to identify a process instance based on business-specific criteria, rather than relying solely on the system-generated process instance ID.
The business key allows you to associate a process instance with a specific business entity or context.

//todo -- определиться с бизнес-ключом, чтоб задаввать его как свойство процесса
You can set up a business key as property of the start event form when selecting an _Input Dialog_ form. Any process variable can be used as a business key.

image::bpm:bpmn-subprocesses/setting-business-key.png[,500]

Business key can be updated programmatically via API:

[source,java]
----
runtimeService.updateBusinessKey("processInstanceId", "businessKey");
----

Or using `ProcessFormContext`:

[source,java]
----
processFormContext.processStarting()
        .withBusinessKey("business key")
        .saveInjectedProcessVariables()
        .start();
----

[[executions]]
=== Executions


[[historic-process-instances]]
=== Historic Process Instances


[[dmn-engine]]
== DMN Engine

The Flowable *DMN engine* evaluates decision tables and executes business rules defined in DMN format.
It allows users to create complex decision logic that can be integrated with BPMN processes, enabling dynamic decision-making based on input data.
The DMN engine supports multiple decision models, operates within a specific execution context, and provides flexible output handling.
See the xref:jmix-bpm-api.adoc#flowable-dmn-api[DMN API] section, how to access it programmatically.

Additionally, it can be accessed via a xref:jmix-bpm-api.adoc#flowable-dmn-rest-api[DMN REST API], allowing external systems to evaluate decisions programmatically.
This functionality enhances the agility and responsiveness of business processes by facilitating informed decision-making.


