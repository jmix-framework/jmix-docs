= 监听器

有几种方式能处理流程引擎事件，事件是指任务创建、活动完成等。

[[execution-listeners]]
== Execution Listeners




[[task-listeners]]
== Task Listeners


[[spring-events-bpm]]
== Spring Events for BPM

BPM 扩展组件还引入了一组 Spring 应用事件，会发布下列事件：

* `UserTaskAssignedEvent`
* `UserTaskCreatedEvent`
* `UserTaskCompletedEvent`
* `ActivityStartedEvent`
* `ActivityCompletedEvent`
* `ProcessStartedEvent`
* `ProcessCompletedEvent`

下面示例中，每次分配用户任务时，都会发送一个 email 通知：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/listener/TaskAssignedNotificationSender.java[tags=event-listener-1;event-listener-2]
----

<1> 声明方法为事件监听器。
<2> 每次 `UserTaskAssignedEvent` 事件发布时，都会触发监听器。
<3> 加载 `User` 实体，以便获取用户姓名和 email 地址。`UserTaskAssignedEvent` 事件包含任务执行人的 `username`。
<4> `UserTaskAssignedEvent` 事件包含一个 `Task` 对象，里面有关于用户任务的信息。
<5> 创建并发送 email。参阅 xref:email:index.adoc[Email 发送] 了解详情。

如需在监听器中获取流程变量的值，可以这么做：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/listener/TaskAssignedNotificationSender2.java[tags=get-variable-1;get-variable-2]
----

默认情况下，在任何流程中分配用户任务都会触发监听器。如果只想在特定的流程定义中发送通知，可以在监听器的方法体中检查流程定义：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/listener/TaskAssignedNotificationSender.java[tags=specific-process-1;specific-process-2]
----

或者可以定义一个 SpEL（Spring 表达式语言）表达式，用来匹配处理的事件：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/listener/TaskAssignedNotificationSender3.java[tags=spel-example-1;spel-example-2]
----
