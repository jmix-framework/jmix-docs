= События UI

`ApplicationEvent` из Spring можно использовать для реагирования на события в различных частях приложения. Чтобы отослать события компонентам UI, включая открытые xref:views/views.adoc[экраны], необходимо использовать бин `UiEventPublisher` фреймворка.

Для правильного обновления UI класс, реализующий `AppShellConfigurator`, должен содержать аннотацию `@Push`. Обычно это основной класс приложения Spring Boot:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/OnboardingApplication.java[tags=main-class-push;main-class]
----

Бин `UiEventPublisher` предоставляет следующие методы:

* `publishEventForCurrentUI()` - публикует событие только для текущей активной вкладки браузера, из которой было отправлено событие.

* `publishEvent()` - публикует событие для всех вкладок браузера в текущей сессии.

* `publishEventForUsers()` - публикует событие для всех вкладок браузера для всех сессий пользователей, указанных в коллекции `usernames`, которая передается в качестве второго параметра. Если коллекция `usernames` равна `null`, событие будет опубликовано для всех пользователей.

[[usage-example]]
== Пример использования

Рассмотрим следующую задачу: пользователи должны завершить процесс онбординга, следуя определенным шагам. Каждый шаг представлен экземпляром сущности, и есть экран, который показывает информацию о завершенных шагах. Кроме того, пользователям нужно напоминание о количестве незавершенных шагов, которое обновляет свое значение каждый раз, когда состояние шагов изменяется. Например, таким напоминанием может быть значок в элементе меню.

Экземпляры сущностей, представляющие шаги, могут обновляться на экранах деталей сущностей или в бизнес-логике приложения. Значок элемента меню должен обновляться каждый раз, когда сущность, связанная с текущим пользователем, изменяется.

Задачу можно решить следующим образом:

. Создайте класс события:
+
[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/event/OnboardingStatusChangedEvent.java[tags=application-event]
----

. Создайте слушатель события в экране, который должен быть уведомлен. В приведенном ниже примере это главный экран:
+
[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/main/MainView.java[tags=init-event;!init-initialLayout;ui-event-listener]
----
<1> Обновление статуса онбординга в первый раз, когда пользователь открывает главный экран.
<2> Аннотация `@EventListener` на методе включает обработку событий приложения.
<3> Получение количество незавершенных шагов из сервиса.
<4> Установка количества незавершенных шагов в виде значка для элемента меню.

. Отправьте событие, используя бин `UiEventPublisher` из xref:data-access:entity-events.adoc#entity-changed-event[слушателя EntityChangedEvent]:
+
[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/listener/UserStepEventListener.java[tags=ui-event-publisher-1;ui-event-publisher-2]
----
<1> Публикация события для всех UI всех сессий пользователя, указанного в измененной сущности `UserStep`.

. Элемент меню с значком, отображающим количество незавершенных шагов

image::ui-events/on-boarding-status.png[align="center",width="228"]