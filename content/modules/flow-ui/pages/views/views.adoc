= Views

A _view_ is a basic building block of the application UI. It is a root of the hierarchy of visual components and can also contain data components, actions and facets.

A view is defined by a Java class. The class usually has a corresponding XML file called _descriptor_, which defines the view content. So there is a clear separation between declarative layout of components defined in XML and programmatic initialization and event handling logic written in Java.

[[view-classes]]
== View Classes

Jmix provides the following base classes for views:

image::views/views-diagram.svg[align="center"]

[[view]]
=== View

`View` defines the state and behavior of all varieties of existing views.

[[standard-main-view]]
=== StandardMainView

`StandardMainView` is a root application view which is opened after login. It contains the {vaadin-docs}/components/app-layout[AppLayout^] component with the main menu.

image::views/main-view-1.png[align="center"]

[[standard-view]]
=== StandardView

`StandardView` is a base class for regular views. Such views can be shown either inside the main view using navigation to the view URL or in a popup dialog window.

Below is a standard view opened using the `/my-onboarding` URL:

image::views/standard-view-1.png[align="center"]

[[standard-list-view]]
=== StandardListView

`StandardListView` is a base class for CRUD views displaying a list of entities. It can also be used as a lookup view to select entity instances from the list and return them to the caller. A list view usually uses the xref:vc/components/dataGrid.adoc[] or xref:vc/components/treeDataGrid.adoc[] components.

Below is a list view opened using the `/departments` URL:

image::views/list-view-1.png[align="center"]

The same view opened in a dialog for selecting entities:

image::views/list-view-2.png[align="center"]

[[standard-detail-view]]
=== StandardDetailView

`StandardDetailView` is a base class for CRUD views displaying a single entity instance. A detail view usually uses the xref:vc/layouts/formLayout.adoc[] component.

Below is a detail view opened using entity id in the URL:

image::views/detail-view-1.png[align="center"]

The same view opened in a dialog:

image::views/detail-view-2.png[align="center"]

[[view-annotations]]
== View Annotations

Annotations on view classes provide information about the views to the framework. Some annotations are applicable to any type of view, some of them can be used only on entity list or detail views.

[[common-annotations]]
=== Common Annotations

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/myonboarding/MyOnboardingView.java[tags=annotations]
----

* `@ViewController` annotation indicates that the class is a view. The value of the annotation is the view id which can be used to refer to the view from the xref:menu-config.adoc[main menu] or when opening the view programmatically.

* `@ViewDescriptor` annotation connects the view class to the XML descriptor. The value of the annotation specifies the path to the descriptor file. If the value contains a file name only, it is assumed that the file is located in the same package as the view class.

* `@com.vaadin.flow.router.Route` defines a URL path for navigation to this view. As long as the view should be opened inside the main view, the `layout` attribute specifies the main view class.

* `@DialogMode` annotation defines parameters of the dialog window when the view is opened as a dialog.

* `@com.vaadin.flow.server.auth.AnonymousAllowed` makes the view available without authentication. By default, only the login view is available to the anonymous (not authenticated) session.
+
TIP: See the https://github.com/jmix-framework/jmix-samples-2/tree/main/user-registration[User Registration^] sample project for how the `@AnonymousAllowed` annotation is used in a view for self-registration of users.

[[list-view-annotations]]
=== List View Annotations

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/department/DepartmentListView.java[tags=annotations]
----

[[lookup-component]]
* `@LookupComponent` annotation specifies an id of a UI component to be used for getting a value returned from the lookup.

* `@PrimaryLookupView` annotation indicates that this view is the default lookup view for the specified entity. The annotation has greater priority than the `\{entity_name}.lookup` / `\{entity_name}.list` xref:views/opening-views.adoc#view-inference-conventions[name convention].

[[detail-view-annotations]]
=== Detail View Annotations

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/department/DepartmentDetailView.java[tags=annotations]
----

[[edited-entity-container]]
* `@EditedEntityContainer` annotation specifies a data container that contains the edited entity.

* `@PrimaryDetailView` annotation indicates that this view is the default detail view for the specified entity. The annotation has greater priority than the `\{entity_name}.detail` xref:views/opening-views.adoc#view-inference-conventions[name convention].

[[view-controller-methods]]
== View Controller Methods

In this section, we describe some methods of view controller base classes that can be invoked or overridden in the application code.

[[methods-of-all-views]]
=== Methods of All Views

* `close()` - requests closing the view with the passed `StandardOutcome` enum value or a `CloseAction` object.
+
[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/myonboarding/MyOnboardingView.java[tags=close-with-discard]
----
+
The parameter value is propagated to the xref:views/views.adoc#before-close-event[BeforeCloseEvent] and xref:views/views.adoc#after-close-event[AfterCloseEvent], so the information about the reason why the view was closed can be obtained in the listeners.

* `closeWithDefaultAction()` - requests closing the view with `StandardOutcome.CLOSE`.

* `setPreventBrowserTabClosing()` - sets whether this view should prevent the browser tab from closing accidentally if the xref:ui-properties.adoc#jmix.ui.view.preventBrowserTabClosing[jmix.ui.view.preventBrowserTabClosing] property is set to `true` (which is `false` by default). Enabled by default for xref:views/views.adoc#standard-detail-view[detail views].

* `getViewData()` - returns the `ViewData` object that serves as a registry for all xref:data-components.adoc[data components] defined in the view XML descriptor. You can use its `loadAll()` method to trigger all data loaders of the view:
+
[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/department/DepartmentListView.java[tags=view-data]
----

* `getViewAttributes()` - returns the `ViewAttributes` object that serves as a storage of values associated with their names. Uses `VaadinSession` as a store. For example, xref:views/views.adoc#standard-detail-view[detail view] uses `ViewAttributes` to store *read-only state* and *locked status* and revert these settings if a view is refreshed.

* `getPageTitle()` - returns the title of a view. By default, returns localized value defined in a view descriptor. Can be overridden to provide dynamic title.
+
[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserDetailView.java[tags=page-title]
----

* `beforeLeave()` - a callback that is executed before navigating to another view is made. Part of Vaadin *Navigation Lifecycle*.
** The event allows the navigation to be _postponed_, _canceled_, or _changed_ to a different destination.
** Isn't executed when a view is opened in a dialog mode.
** Must not be overridden without calling `super` method as it executes framework related code.

* `beforeEnter()` - a callback that is executed before navigating to a view. Part of Vaadin *Navigation Lifecycle*.
** Can be used to obtain `Location` object and allows changing the navigation target to go to a different destination from the original one.
** Isn't executed when a view is opened in a dialog mode.
** Must not be overridden without calling `super` method as it executes framework related code.

* `afterNavigation()` - a callback that is executed after navigation has been completed. Part of Vaadin *Navigation Lifecycle*.
** Can be used to obtain `Location` object.
** Isn't executed when a view is opened in a dialog mode.
** Must not be overridden without calling `super` method as it executes framework related code.


[[methods-of-standard-list]]
=== Methods of StandardListView

* `closeWithDiscard()` - requests closing the view with `StandardOutcome.DISCARD`.

* `getLookupComponent() / findLookupComponent()` - returns a component to be used for getting a value returned from this xref:views/views.adoc#standard-list-view[lookup view]. By default, returns a component with an `id` specified by the xref:views/views.adoc#lookup-component[@LookupComponent] annotation.

* `setSelectionValidator()` - sets a predicate that tests if selected items can be processed by `SelectionHandler`.

* `setSelectionHandler()` - sets a callback that handles selected items. By default, adds items to a xref:data/collection-container.adoc[collection container] if a xref:views/views.adoc#standard-list-view[lookup view] is opened for a xref:vc/components/dataGrid.adoc[DataGrid] component or sets a single value if a xref:views/views.adoc#standard-list-view[lookup view] is opened for a field, for example xref:vc/components/entityPicker.adoc[EntityPicker].
+
[source,java,indent=0]
----
DialogWindow<View<?>> dialog = dialogWindows.lookup(ProjectDetailView.this, User.class) // <1>
        .withSelectHandler(users -> { // <2>
            for (User user : users) {
                ProjectParticipant projectParticipant = dataManager.create(ProjectParticipant.class);
                projectParticipant.setUser(user);
                projectParticipant.setProject(getEditedEntity());
                projectParticipant.setRole(projectRole);
                participantsDc.getMutableItems().add(projectParticipant);
            }
        })
        .build();

View<?> view = dialog.getView();
if (view instanceof MultiSelectLookupView multiSelectLookupView) { // <3>
    multiSelectLookupView.setLookupComponentMultiSelect(true);
}

dialog.open();
----
<1> - Create a lookup view builder not bound to any UI component.
<2> - Define selection handler for the lookup view.
<3> - Check if actual lookup view supports multiple selection.

[[methods-of-standard-detail]]
=== Methods of StandardDetailView

* `getEditedEntity()` - when the view is shown, returns an instance of the entity being edited. It’s the instance that is set in the data container specified in the xref:views/views.adoc#edited-entity-container[@EditedEntityContainer] annotation. +
In the xref:views/views.adoc#init-event[InitEvent] listener, this method returns `null`. In the xref:views/views.adoc#before-show-event[BeforeShowEvent] listener, this method returns the instance passed to the view for editing (later in the view opening process the entity is reloaded and a different instance is set to the data container).

The following methods can be used to close the edit screen:

[[close-with-save-method]]
* `closeWithSave()` - validates and saves changes, then closes the view with `StandardOutcome.SAVE`. You can call this method from a custom event listener or add the built-in `detail_saveClose` action to the view.

* `closeWithDiscard()` - ignores any unsaved changes and closes the view with `StandardOutcome.DISCARD`. You can call this method from a custom event listener or add the built-in `detail_discard` action to the view.

If the view has unsaved changes in xref:data/data-context.adoc[DataContext], a dialog with a corresponding message will be displayed before the view is closed. You can adjust the notification type using the xref:ui-properties.adoc#jmix.ui.view.use-save-confirmation[jmix.ui.view.use-save-confirmation] application property. If you use the `closeWithDiscard()` or `close(StandardOutcome.DISCARD)` methods, unsaved changes are ignored without any message.


* `save()` - validates and saves changes without closing the view. You can call this method from a custom event listener or add the built-in `detail_save` action to the view. Also, you can override the `save()` method to perform some operations after the data has been saved, for example:
+
[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserDetailView.java[tags=overridden-save-method]
----
<1> - Call super method to execute the default logic.
<2> - You can perform actions after the data has been saved.


* `setReloadSaved(boolean)` - sets whether edited entity should be reloaded after the xref:views/views.adoc#close-with-save-method[closeWithSave()] method invoked. The default value is `false`. It's set to `true` if a view is opened in a dialog mode.

* `setShowSaveNotification(boolean)` - sets whether a notification should be shown in case of a successful save. The default value is `true`.

* `setShowValidationErrors(boolean)` - sets whether to indicate about errors after components validation using the xref:views/view-validation.adoc#showValidationErrors[showValidationErrors()] method. The default value is `true`.

* `setCrossFieldValidationEnabled(boolean)` - sets whether cross-field validation should be performed before saving changes. It uses `UiCrossFieldChecks` constraint group to validate bean instance. The default value is `true`.

* `getLockStatus()` - Returns lock status of the currently edited entity instance. Possible variants:
** `LockStatus.NOT_SUPPORTED` - if the entity does not support lock.
** `LockStatus.LOCKED` - if the entity instance is successfully locked.
** `LockStatus.FAILED` - if lock failed because the entity is already locked by someone else.


[[events]]
== View Events

This section describes the view lifecycle events that can be handled in controllers.

[[init-event]]
=== InitEvent

`InitEvent` is the first event in the view opening process. The view and all its declaratively defined components are created, and dependency injection is completed. Some visual components are not fully initialized, for example, buttons are not linked with actions. In this event listener, you can create visual and data components.

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserDetailEventsView.java[tags=init-event]
----

NOTE: The event is triggered only once after the view is created. This means that if the navigation to the view occurs for the first time, the event triggers. However, if navigation is performed to the same view that is currently open more than once, for example, by clicking on the same menu item multiple times, the event will not be triggered because the view instance has already been created.

[[before-show-event]]
=== BeforeShowEvent

`BeforeShowEvent` is the second event (after `View.InitEvent`) in the view opening process. All components have completed their internal initialization procedures. Data loaders have been triggered by the automatically configured `DataLoadCoordinator` facet. Security restrictions are applied to UI components. In this event listener, you can load data, check permissions and modify UI components. For example:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserListEventsView.java[tags=users-loader;before-show-event]
----

NOTE: Consequent navigation to the same view that is currently open, leads to triggering `View.BeforeShowEvent` again for the same instance of the view. For example, the user navigates to a view for the first time, then a view instance is created and `View.BeforeShowEvent` triggers. Then, the user clicks on the same menu item, navigating to the same opened view again. We have the same view instance, but `View.BeforeShowEvent` triggers again. +
If the `View.BeforeShowEvent` listener contains logic to add components or load data, it will be done performed, which could lead to adding duplicate components or reloading data.

[[ready-event]]
=== ReadyEvent

`ReadyEvent` is the last event (after `View.BeforeShowEvent`) in the view opening process. In this event listener, you can make final configuration of the view according to loaded data and show notifications or dialogs.

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserListEventsView.java[tags=notifications-bean;ready-event]
----

NOTE: Consequent navigation to the same view that is currently open, leads to triggering `View.ReadyEvent` again for the same instance of the view. For example, the user navigates to a view for the first time, then a view instance is created and `View.ReadyEvent` triggers. Then, the user clicks on the same menu item, navigating to the same opened view again. We have the same view instance, but `View.ReadyEvent` triggers again. +
If the `View.ReadyEvent` listener contains logic to add components or load data, it will be done performed, which could lead to adding duplicate components or reloading data.

IMPORTANT: Both `BeforeShowEvent` and `ReadyEvent` work this way, because in case of navigation, they are fired by Vaadin's `BeforeEnterEvent` and `AfterNavigationEvent` lifecycle event handlers respectively.

[[attach-event]]
=== AttachEvent

`AttachEvent` is fired after a view is attached to the UI.

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserListEventsView.java[tags=attach-event]
----

NOTE: An event is fired by Vaadin, since a view is a UI component too.

[[before-close-event]]
=== BeforeCloseEvent

`BeforeCloseEvent` is the first event in the view closing process. The view is still displayed and fully functional. In this event listener, you can check any conditions and prevent closing using the `preventClose()` method of the event.

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserListEventsView.java[tags=before-close-event]
----

NOTE: In case of navigation, you need to postpone it too. Check the type of action and if it's `NavigateCloseAction`, then obtain Vaadin's `BeforeLeaveEvent` and call its `postpone()` method. A more complex example that considering both *dialog* mode and *navigation* can be found in the `io.jmix.flowui.view.StandardDetailView#preventUnsavedChanges` method which handles the default `preventUnsavedChanges` logic.


[[after-close-event]]
=== AfterCloseEvent

`AfterCloseEvent` is the second event (after `View.BeforeCloseEvent`) in the view closing process. In this event listener, you can show notifications or dialogs after closing the view, for example:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserListEventsView.java[tags=notifications-bean;after-close-event]
----

[[detach-event]]
=== DetachEvent

`DetachEvent` is fired before a view is detached from the UI. This event listener can be used for releasing resources acquired by the view.

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserListEventsView.java[tags=detach-event]
----

NOTE: An event is fired by Vaadin, since a view is a UI component too.

[[query-parameters-change-event]]
=== QueryParametersChangeEvent

`QueryParametersChangeEvent` is an event that informs which query parameters a view was opened with.

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserListEventsView.java[tags=query-parameters-change-event]
----

[[init-entity-event]]
=== InitEntityEvent

`InitEntityEvent` is fired in views inherited from `StandardDetailView` before the new entity instance is set to edited entity container.

Use this event listener to initialize default values in the new entity instance, for example:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserDetailEventsView.java[tags=init-entity-event]
----

[[validation-event]]
=== ValidationEvent

`ValidationEvent` is fired in views inherited from `StandardDetailView` when the view is validated on saving the view data context. Use this event listener to perform additional validation of the view.

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserDetailEventsView.java[tags=validation-event]
----

[[before-save-vent]]
=== BeforeSaveEvent

`BeforeSaveEvent` is fired in views inherited from `StandardDetailView` before saving the view data context. Use this event listener to prevent saving, alter entity attribute values before saving or/and interact with the user before save.

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserDetailEventsView.java[tags=before-save-event]
----
<1> - Interrupt the saving process if passwords do not match
<2> - Set encoded password to the entity

[[after-save-event]]
=== AfterSaveEvent

`AfterSaveEvent` is fired in views inherited from `StandardDetailView` after saving the view data context. Use this event listener to notify users after save, for example:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/user/UserDetailEventsView.java[tags=notifications-bean;after-save-event]
----

