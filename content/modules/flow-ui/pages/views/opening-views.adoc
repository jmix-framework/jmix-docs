= Открытие экранов

Обычный (не корневой) экран можно открыть либо перейдя на его URL (указанный в аннотации `@Route`), либо на текущей веб-странице, открыв диалоговое окно.

При использовании навигации, URL веб-браузера отражает состояние пользовательского интерфейса приложения, что позволяет использовать _глубокие ссылки_. Пользователь приложения может скопировать и поделиться адресом URL, тем самым предоставляя ссылку на определенный экран и его текущее состояние, например, на сведения о конкретном экземпляре сущности.

Минусом навигации является относительная сложность передачи параметров в открываемый экран. Их можно передавать только в URL в качестве параметров {vaadin-docs}/routing/route-parameters[route^] или {vaadin-docs}/routing/additional-guides/query-parameters[query^]. Кроме того, невозможно вернуть в вызывающий код какие-либо значения из экрана после его закрытия.

При открытии экрана в диалоговом окне URL браузера не изменяется, но зато экземпляр открытого экрана доступен вызывающему коду. Он позволяет передавать любые значения непосредственно в экземпляр экрана и возвращать результаты после закрытия экрана. Этот подход используется при открытии экранов списков для выбора и возврата экземпляров сущностей в компонентах выбора.

Главное меню открывает экраны с помощью навигации. Стандартные действия xref:actions/list-actions.adoc#list_create[list_create] и xref:actions/list-actions.adoc#list_edit[list_edit] также открывают экраны деталей с помощью навигации, но их можно настроить на использование диалоговых окон. Стандартное действие xref:actions/entity-picker-actions.adoc#entity_lookup[entity_lookup] всегда открывает экран списка в диалоговом окне, чтобы иметь возможность вернуть выбранные сущности.

Ниже описывается, как программно открывать экраны в коде приложения.

[[navigation]]
== Навигация

Чтобы открыть экран с помощью навигации на его URL, инжектируйте бин `ViewNavigators` и используйте его fluent-интерфейс для указания текущего экран и класса открываемого экрана:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=viewNavigators;navigateToView]
----

`navigate()` - это терминальный метод, выполняющий навигацию.

Если вызывающий класс не является экраном, и вы не можете передать `this` в качестве текущего экрана, используйте `UiComponentUtils.getCurrentView()`, чтобы найти открытый в данный момент экран.

Если необходимо вернуться к вызывающему экрану после закрытия открываемого экрана, вызовите метод `withBackwardNavigation(true)`:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=viewNavigators;navigateToViewThenBack]
----

Чтобы перейти к экрану списка, используйте метод `listView()`, принимающий класс сущности. Класс экрана списка будет выбран по <<view-inference-conventions,соглашению>>. Например:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=viewNavigators;navigateToListView]
----

Идентификатор или класс экрана списка можно указать явно, например:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=viewNavigators;navigateToListViewWithClass]
----

Чтобы перейти к экрану деталей, используйте метод `detailView()`, принимающий класс сущности или визуальный компонент, привязанный к сущности. Класс экрана деталей будет выбран по <<view-inference-conventions,соглашению>>.

Чтобы создать новый экземпляр сущности, вызовите `newEntity()`. Например:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=viewNavigators;navigateToCreateEntity]
----

Чтобы отредактировать экземпляр сущности, вызовите `editEntity()`. Например:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=viewNavigators;navigateToEditEntity]
----

Идентификатор или класс экрана деталей можно указать явно, используя методы `withViewId()` и `withViewClass()`.

[[passing-parameters]]
=== Передача параметров

Рекомендуемый способ передачи параметров в экран, открываемый при навигации — использование метода `withQueryParameters()`:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=viewNavigators;navigateToViewWithQueryParameters]
----

В этом случае к URL будет добавлен параметр, например:

[source,text]
----
http://localhost:8080/FancyMessageView?message=Hello%20World!
----

В открываемом экране для получения значения параметра используйте обработчик `QueryParametersChangeEvent`:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/fancymessage/FancyMessageView.java[tags=message;QueryParametersChangeEvent]
----

Другой вариант — использовать метод `withAfterNavigationHandler()` и передать параметр непосредственно объекту открываемого экрана:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=viewNavigators;navigateToViewWithAfterNavigationHandler]
----

В этом случае URL не будет содержать параметр:

[source,text]
----
http://localhost:8080/FancyMessageView
----

Этот подход проще и позволяет передавать сложные типы, но недостаток тот же, что и при открытии экранов в диалоговых окнах: он не обеспечивает глубокую ссылку, и состояние экрана будет потеряно, если пользователь обновит веб-страницу.

[[dialog-windows]]
== Открытие диалоговых окон

Бин `DialogWindows` предоставляет удобный интерфейс для открытия экранов в диалоговых окнах. Его терминальные методы предоставляют доступ к экземпляру открываемого экрана, что позволяет передавать входные параметры непосредственно в экземпляр экрана и добавлять слушатели для получения результатов из открываемого экрана после его закрытия.

Чтобы открыть экран в виде диалогового окна, инжектируйте бин `DialogWindows` и вызовите метод `view()`, передав ему текущий экран и класс открываемого экрана. Затем вызовите терминальный метод `open()`:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=dialogWindows;openView]
----

Если вам нужно передать параметры в открываемый экран, вызовите терминальный метод `build()`, задайте параметры для экрана, затем откройте диалоговое окно:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=dialogWindows;openViewWithParams]
----

NOTE: Когда вы вызываете метод `build()`, в экране генерируется событие xref:views/view-events.adoc#init-event[InitEvent]. Если вы открываете диалоговое окно для создания новой сущности, при вызове метода `build()` также будет сгенерировано событие xref:views/view-events.adoc#init-entity-event[InitEntityEvent]. Остальные xref:views/view-events.adoc[события жизненного цикла] экрана срабатывают при вызове метода `open()`.

Чтобы получить результат из открываемого экрана после его закрытия, добавьте в диалоговое окно слушатель `AfterCloseEvent`:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=dialogWindows;openViewWithParamsAndResults]
----

Объект `AfterCloseEvent` содержит действие закрытия (`CloseAction`) переданное методу `close()` экрана. Например, когда стандартный экран деталей сущности закрывается с помощью кнопки *ОК* , действие закрытия имеет значение `save`. Вы можете проанализировать действие закрытия, используя методы `getCloseAction()` или `closedWith()` объекта события.

Слушатель `AfterCloseEvent` можно также добавить, используя fluent-интерфейс:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=dialogWindows;openViewWithResults]
----

Чтобы выбрать сущности из экрана списка, откройте экран, используя метод `lookup()`:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=dialogWindows;openLookupView]
----

Используйте метод `withSelectHandler()`, чтобы предоставить лямбду, которая принимает коллекцию экземпляров сущностей, выбранных в открываемом экране.

Чтобы создать новый экземпляр сущности в экране деталей, укажите класс экрана и вызовите метод `newEntity()`. Используйте слушатель `AfterCloseEvent`, чтобы получить созданную сущность. Например:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=dialogWindows;openDetailViewToCreateEntity]
----

Чтобы отредактировать существующую сущность в экране деталей, предоставьте экземпляр для редактирования, используя метод `editEntity()`:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/sample/SampleView.java[tags=dialogWindows;openDetailViewToEditEntity]
----

Входные параметры для экрана списка и экрана деталей можно предоставить так же, как описано для простого экрана в начале этого раздела: вызовите терминальный метод `build()`, установите параметры экрана, затем откройте диалоговое окно.

[[view-inference-conventions]]
== Соглашения о выводе имен экранов

Экран списка или деталей можно вывести из класса сущности.

При переходе к экрану списка с помощью `viewNavigators.listView(SomeEntity.class).navigate()`, фреймворк выбирает экран в следующем порядке:

. Экран с идентификатором `SomeEntity.list`.
. Экран, помеченный `@PrimaryLookupView(SomeEntity.class)`.
. Экран с идентификатором `SomeEntity.lookup`.

При открытии экрана списка для поиска с помощью `dialogWindows.lookup(this, SomeEntity.class).open()`, фреймворк выбирает экран в следующем порядке:

. Экран, помеченный `@PrimaryLookupView(SomeEntity.class)`.
. Экран с идентификатором `SomeEntity.lookup`.
. Экран с идентификатором `SomeEntity.list`.

При переходе к экрану деталей или открытии его в диалоговом окне фреймворк выбирает экран в следующем порядке:

. Экран, помеченный `@PrimaryDetailView(SomeEntity.class)`.
. Экран с идентификатором `SomeEntity.detail`.
