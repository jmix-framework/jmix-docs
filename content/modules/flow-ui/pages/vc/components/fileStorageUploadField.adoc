= fileStorageUploadField 文件存储上传

++++
<div class="jmix-ui-live-demo-container">
    <a href="https://demo.jmix.io/ui-samples/sample/file-storage-upload-field" class="live-demo-btn" target="_blank">在线示例</a>
</div>
++++

`fileStorageUploadField` 支持用户将文件上传至 xref:files:file-storage.adoc[文件存储] 并作为 `FileRef` 对象连接至实体属性。

* XML 元素：`fileStorageUploadField`

* Java 类：`FileStorageUploadField`

== 基本用法

这个组件可以包含标题、已上传文件的链接和一个上传按钮。当点击上传按钮的时候，会弹出系统标准的文件选择器，用户可以在这里选择需要上传的文件。

image::visual-components/components/file-storage-upload-basics.gif[align="center"]

下面例子中，`User` 实体的 `picture` 属性是 `FileRef` 类型。

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/entity/User.java[tags=picture]
----

[source,xml,indent=0]
----
include::example$/onboarding/src/main/resources/com/company/onboarding/view/component/filestorageupload/file-storage-upload-view.xml[tags=data;layout;basics]
----

`fileStorageUploadField` 的 `dataContainer` 属性指定连接的数据容器；`property` 属性指定展示在 `fileStorageUploadField` 的实体属性名。

如需将文件在实体属性中以字节数组的格式存储而非 `FileRef`，请使用 xref:flow-ui:vc/components/fileUploadField.adoc[fileUploadField] 组件。

上传的文件会立即保存在默认的 `FileStorage` 中。如需以编程的方式控制文件的存储，可以使用 <<fileStoragePutMode,fileStoragePutMode>> 属性。

== XML 属性

xref:vc/common-attributes.adoc#id[id] -
<<acceptedFileTypes,acceptedFileTypes>> -
xref:vc/common-attributes.adoc#alignSelf[alignSelf] -
xref:vc/common-attributes.adoc#classNames[classNames] -
<<clearButtonAriaLabel,clearButtonAriaLabel>> -
<<clearButtonVisible,clearButtonVisible>> -
xref:vc/common-attributes.adoc#colspan[colspan] -
<<connectingStatusText,connectingStatusText>> -
xref:vc/common-attributes.adoc#dataContainer[dataContainer] -
<<dropAllowed,dropAllowed>> -
xref:vc/common-attributes.adoc#enabled[enabled] -
xref:vc/common-attributes.adoc#errorMessage[errorMessage] -
<<fileNameVisible,fileNameVisible>> -
<<fileNotSelectedText,fileNotSelectedText>> -
<<fileStorageName,fileStorageName>> -
<<fileStoragePutMode,fileStoragePutMode>> -
<<fileTooBigText,fileTooBigText>> -
xref:vc/common-attributes.adoc#height[height] -
xref:vc/common-attributes.adoc#helperText[helperText] -
<<incorrectFileTypeText,incorrectFileTypeText>> -
xref:vc/common-attributes.adoc#invalid[invalid] -
xref:vc/common-attributes.adoc#label[label] -
<<maxFileSize,maxFileSize>> -
xref:vc/common-attributes.adoc#maxHeight[maxHeight] -
xref:vc/common-attributes.adoc#maxWidth[maxWidth] -
xref:vc/common-attributes.adoc#minHeight[minHeight] -
xref:vc/common-attributes.adoc#minWidth[minWidth] -
<<processingStatusText,processingStatusText>> -
xref:vc/common-attributes.adoc#property[property] -
xref:vc/common-attributes.adoc#readOnly[readOnly] -
<<remainingTimeText,remainingTimeText>> -
<<remainingTimeUnknownText,remainingTimeUnknownText>> -
xref:vc/common-attributes.adoc#required[required] -
xref:vc/common-attributes.adoc#requiredIndicatorVisible[requiredIndicatorVisible] -
xref:vc/common-attributes.adoc#requiredMessage[requiredMessage] -
<<uploadDialogCancelText,uploadDialogCancelText>> -
<<uploadDialogTitle,uploadDialogTitle>> -
<<uploadIcon,uploadIcon>> -
<<uploadText,uploadText>> -
xref:vc/common-attributes.adoc#visible[visible] -
xref:vc/common-attributes.adoc#width[width]

[[acceptedFileTypes]]
=== acceptedFileTypes

指定服务器能接收的文件类型。文件格式使用 https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_Types[MIME 类型模式^] 或文件扩展名定义。

NOTE: MIME 类型具有广泛的支持，而文件扩展名仅在某些浏览器支持，因此需要尽可能避免使用扩展名。

[source,xml,indent=0]
----
include::example$/onboarding/src/main/resources/com/company/onboarding/view/component/filestorageupload/file-storage-upload-view.xml[tags=acceptedFileTypes]
----

[[clearButtonAriaLabel]]
=== clearButtonAriaLabel

++++
<div class="jmix-ui-live-demo-container">
    <a href="https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Attributes/aria-label" class="mdn-docs-btn" target="_blank">MDN</a>
</div>
++++

设置清空按钮的 `aria-label` 属性。

[[clearButtonVisible]]
=== clearButtonVisible

设置是否在文件名后面显示清除按钮。仅当 <<fileNameVisible,fileNameVisible="true">> 有效。

默认值是 `false`。

[[connectingStatusText]]
=== connectingStatusText

设置当连接建立后在上传窗口展示的状态文本。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

[[dropAllowed]]
=== dropAllowed

++++
<div class="jmix-ui-live-demo-container">
    <a href="https://vaadin.com/docs/latest/components/upload/#drag-drop" class="vaadin-docs-btn" target="_blank">Vaadin</a>
</div>
++++

设置组件是否支持拖放文件进行上传。

默认值是 `true`。

[[fileNameVisible]]
=== fileNameVisible

`fileNameVisible` 属性设置是否在上传按钮旁边显示上传的文件名称。默认为 `false`。

[[fileNotSelectedText]]
=== fileNotSelectedText

设置当 <<fileNameVisible,fileNameVisible="true">> 而文件还未上传时显示的文本。默认显示 "File is not selected（未选择文件）"。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

[[fileStorageName]]
=== fileStorageName

设置上传文件保存的 xref:files:file-storage.adoc[FileStorage] 名称。如果未设置，则使用默认的文件存储。

[[fileStoragePutMode]]
=== fileStoragePutMode

设置文件放入文件存储的模式。`fileStoragePutMode` 属性默认设置为 `IMMEDIATE`。如果设置为 `MANUAL` 值，则能以编程的方式控制文件的保存：

[source,xml,indent=0]
----
include::example$/onboarding/src/main/resources/com/company/onboarding/view/component/filestorageupload/file-storage-upload-view.xml[tags=fileStoragePutMode]
----

视图控制器中，定义组件和 `TemporaryStorage` 接口。然后订阅文件上传成功或出错的 <<FileUploadSucceededEvent,事件>>：

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/component/filestorageupload/FileStorageUploadView.java[tags=autowired;SucceededEvent]
----

该组件将文件上传至临时存储之后，便会调用 `FileUploadSucceedEvent` 的监听器。

`TemporaryStorage.putFileIntoStorage()` 方法将上传的文件从临时客户端存储移至默认的 xref:files:file-storage.adoc[文件存储]。

CAUTION: 在上传具有 `MANUAL` 模式的 `FileStorageUploadField` 字段后，不会自动触发 xref:vc/common-handlers.adoc#ComponentValueChangeEvent[ComponentValueChangeEvent]，因为 `FileRef` 的值只能在文件上传至永久文件存储后获得。

[[fileTooBigText]]
=== fileTooBigText

++++
<div class="jmix-ui-live-demo-container">
    <a href="https://vaadin.com/api/platform/24.0.5/com/vaadin/flow/component/upload/UploadI18N.Error.html#setFileIsTooBig(java.lang.String)" class="vaadin-docs-btn" target="_blank">Vaadin</a>
</div>
++++

设置当文件大小超出 <<maxFileSize,maxFileSize>> 设置的值后异常信息的文本。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

[[incorrectFileTypeText]]
=== incorrectFileTypeText

++++
<div class="jmix-ui-live-demo-container">
    <a href="https://vaadin.com/api/platform/24.0.5/com/vaadin/flow/component/upload/UploadI18N.Error.html#setIncorrectFileType(java.lang.String)" class="vaadin-docs-btn" target="_blank">Vaadin</a>
</div>
++++

设置当文件扩展名不包含在 <<acceptedFileTypes,acceptedFileTypes>> 属性时显示的消息。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

[[maxFileSize]]
=== maxFileSize

++++
<div class="jmix-ui-live-demo-container">
    <a href="https://vaadin.com/docs/latest/components/upload/#file-size" class="vaadin-docs-btn" target="_blank">Vaadin</a>
</div>
++++

设置允许上传文件的最大字节数。注意，这是一个客户端层面的约束，会在发送上传请求之前检查。

NOTE: 如果 `MultipartProperties` 可用，默认值从 `MultipartProperties#getMaxFileSize()` 获得，即 1Mb。如需提高应用程序中所有字段支持的最大文件大小，请使用 `MultipartProperties#getMaxFileSize()` 属性。

[[processingStatusText]]
=== processingStatusText

设置当文件上传成功后显示在上传窗口的状态文本。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

[[remainingTimeText]]
=== remainingTimeText

设置显示上传弹窗中剩余上传时间的文本。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

[[remainingTimeUnknownText]]
=== remainingTimeUnknownText

设置当无法计算剩余上传时间时上传弹窗中显示的文本。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

[[uploadDialogCancelText]]
=== uploadDialogCancelText

设置上传弹窗中取消按钮的显示文本。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

[[uploadDialogTitle]]
=== uploadDialogTitle

设置当正在上传文件时上传弹窗的标题。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

[[uploadIcon]]
=== uploadIcon

设置上传按钮的图标。

[[uploadText]]
=== uploadText

设置上传按钮的文本。

该属性可以是文本本身或者 xref:localization:message-bundles.adoc[消息包] 中的一个键值。如果是消息包键值，则必须以 `msg://` 开头。

== 事件和处理器

xref:vc/common-handlers.adoc#AttachEvent[AttachEvent] -
xref:vc/common-handlers.adoc#ComponentValueChangeEvent[ComponentValueChangeEvent] -
xref:vc/common-handlers.adoc#DetachEvent[DetachEvent] -
<<FileUploadFailedEvent,FileUploadFailedEvent>> -
<<FileUploadFileRejectedEvent,FileUploadFileRejectedEvent>> -
<<FileUploadFinishedEvent,FileUploadFinishedEvent>> -
<<FileUploadProgressEvent,FileUploadProgressEvent>> -
<<FileUploadStartedEvent,FileUploadStartedEvent>> -
<<FileUploadSucceededEvent,FileUploadSucceededEvent>> -
xref:vc/common-handlers.adoc#statusChangeHandler[statusChangeHandler] -
xref:flow-ui:vc/components/textField.adoc#validator[validator]

include::../handler-generation-tip.adoc[]

[[FileUploadFailedEvent]]
=== FileUploadFailedEvent

当产生 `Upload` 的 `FailedEvent` 事件时，会触发 `io.jmix.flowui.kit.component.upload.event.FileUploadFailedEvent`。参考 https://vaadin.com/api/platform/24.0.5/com/vaadin/flow/component/upload/Upload.html#addFailedListener(com.vaadin.flow.component.ComponentEventListener)[Upload.addFailedListener(ComponentEventListener)^]。

[[FileUploadFileRejectedEvent]]
=== FileUploadFileRejectedEvent

当产生 `Upload` 的 `FileRejectedEvent` 事件时，会触发 `io.jmix.flowui.kit.component.upload.event.FileUploadFileRejectedEvent`。参考 https://vaadin.com/api/platform/24.0.5/com/vaadin/flow/component/upload/Upload.html#addFileRejectedListener(com.vaadin.flow.component.ComponentEventListener)[Upload.addFileRejectedListener(ComponentEventListener)^]。

[[FileUploadFinishedEvent]]
=== FileUploadFinishedEvent

当产生 `Upload` 的 `FinishedEvent` 事件时，会触发 `io.jmix.flowui.kit.component.upload.event.FileUploadFinishedEvent`。参考 https://vaadin.com/api/platform/24.0.5/com/vaadin/flow/component/upload/Upload.html#addFinishedListener(com.vaadin.flow.component.ComponentEventListener)[Upload.addFinishedListener(ComponentEventListener)^]。

[[FileUploadProgressEvent]]
=== FileUploadProgressEvent

当产生 `Upload` 的 `ProgressUpdateEvent` 事件时，会触发 `io.jmix.flowui.kit.component.upload.event.FileUploadProgressEvent`。参考 https://vaadin.com/api/platform/24.0.5/com/vaadin/flow/component/upload/Upload.html#addProgressListener(com.vaadin.flow.component.ComponentEventListener)[Upload.addProgressListener(ComponentEventListener)^]。

[[FileUploadStartedEvent]]
=== FileUploadStartedEvent

当产生 `Upload` 的 `StartedEvent` 事件时，会触发 `io.jmix.flowui.kit.component.upload.event.FileUploadStartedEvent`。参考 https://vaadin.com/api/platform/24.0.5/com/vaadin/flow/component/upload/Upload.html#addStartedListener(com.vaadin.flow.component.ComponentEventListener)[Upload.addStartedListener(ComponentEventListener)^]。

[[FileUploadSucceededEvent]]
=== FileUploadSucceededEvent

当产生 `Upload` 的 `SucceededEvent` 事件时，会触发 `io.jmix.flowui.kit.component.upload.event.FileUploadSucceededEvent`。参考 https://vaadin.com/api/platform/24.0.5/com/vaadin/flow/component/upload/Upload.html#addSucceededListener(com.vaadin.flow.component.ComponentEventListener)[Upload.addSucceededListener(ComponentEventListener)^]。

使用示例请参考 <<fileStoragePutMode,fileStoragePutMode>>。
