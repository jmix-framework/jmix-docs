= Фоновые задачи

Механизм фоновых задач предназначен для выполнения задач асинхронно, используя контекст безопасности текущего пользователя и обновляя пользовательский интерфейс результатами.

По сравнению с более простыми xref:async-tasks.adoc[асинхронными задачами], API фоновых задач предлагает следующие дополнительные возможности:

* Возможность визуализировать прогресс операции.
* Возможность для пользователя прервать операцию.
* Готовый настраиваемый диалог UI для отображения информации об операции, полосы прогресса и кнопки отмены.

[[basics]]
== Основы
Для использования фоновых задач выполните следующие действия:

. Определите задачу как подкласс абстрактного класса `BackgroundTask`. В конструкторе вашей задачи передайте значение времени ожидания и ссылку на связанный с задачей контроллер экрана.
+
Закрытие экрана прерывает связанные с ним задачи. Кроме того, задача прерывается автоматически после указанного времени ожидания.

. Реализуйте задачу в методе `BackgroundTask.run()`.

. Создайте объект класса `BackgroundTaskHandler`, управляющий задачей, передав экземпляр задачи методу `handle()` бина `BackgroundWorker`. Ссылку на `BackgroundWorker` можно получить путем инжектирования в контроллер экрана или через `ApplicationContext`.

. Запустите задачу, вызвав метод `execute()` объекта `BackgroundTaskHandler`.

[WARNING]
Не читайте и не обновляйте состояние компонентов пользовательского интерфейса и контейнеров данных в методе `BackgroundTask.run()`; вместо этого используйте методы обратного вызова `done()`, `progress()` и `canceled()`. Если вы попытаетесь установить значение компоненту пользовательского интерфейса из фонового потока, будет вызвано исключение `IllegalConcurrentAccessException`.

Ниже приведен пример выполнения фоновой задачи и отслеживания ее прогресса с использованием компонента xref:vc/components/progressBar.adoc[progressBar]:

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/component/progressbar/ProgressBarView.java[tags=background-tasks]
----

<1> Задача, требующая длительного времени для выполнения. Метод `run()` выполняется в отдельном потоке.
<2> Метод `progress()` выполняется в потоке UI, поэтому здесь можно обновлять визуальные компоненты.

[[background-task]]
== Класс BackgroundTask

`BackgroundTask<T, V>` - это параметризованный класс:

1. `T` − тип объектов, отображающих ход выполнения задачи. Объекты этого типа передаются в метод `progress()` задачи во время вызова `TaskLifeCycle.publish()` в рабочем потоке.

2. `V` − тип результата задачи, передаваемый в метод `done()`. Результат можно также получить, вызвав метод `BackgroundTaskHandler.getResult()`, который будет ждать завершения задачи.

Класс `BackgroundTask` потокобезопасный и не определяет собственного состояния. Если вы не создаете поля для временных данных при реализации класса задачи, то вы можете запустить несколько параллельных процессов, используя один экземпляр задачи.

[[background-task-methods]]
== Методы класса BackgroundTask

Подробная информация о методах предоставлена в Javadocs для классов `BackgroundTask`, `TaskLifeCycle` и `BackgroundTaskHandler`.

[[run]]
=== run()

Этот метод реализует задачу. Он вызывается в отдельном рабочем потоке для выполнения задачи.

Метод должен поддерживать внешние прерывания. Для обеспечения этого периодически проверяйте флаг `TaskLifeCycle.isInterrupted()` во время длительных процессов и прекращайте выполнение при необходимости. Кроме того, нельзя молча отбрасывать `InterruptedException` (или любое другое исключение) - вместо этого необходимо либо корректно выйти из метода, либо вообще не обрабатывать исключение.

Также, с использованием метода `isCancelled()` можно проверить, была ли задача прервана с помощью `cancel()`.

[[canceled]]
=== canceled()

Этот метод вызывается только в потоке UI во время контролируемой отмены задачи, например, когда метод `cancel()` вызывается в `TaskHandler`.

[[progress]]
=== progress()

Этот метод вызывается в потоке UI, когда изменяется значение прогресса. Например, после вызова метода `taskLifeCycle.publish()`.

[[done]]
=== done()

Этот метод вызывается в потоке UI, когда задача завершена.

[[handle-timeout-exception]]
=== handleTimeoutException()

Этот метод вызывается в потоке UI, когда истекло время ожидания задачи. Если окно, в котором выполняется задача, закрывается, задача останавливается без уведомления.

[[handle-exception]]
=== handleException()

Этот метод вызывается в потоке UI, когда возникают любые исключения.

[[notes-and-tips]]
== Заметки и советы

1. Используйте метод `dialogs.createBackgroundTaskDialog()` для отображения модального окна с индикатором прогресса и кнопкой *Отмена*. Он позволяет определить тип индикации прогресса и разрешить или запретить отмену фоновой задачи для окна.
2. Если необходимо использовать определенные значения визуальных компонентов в потоке задачи, нужно реализовать их получение в методе `getParams()`, который выполняется в потоке пользовательского интерфейса после запуска задачи. В методе `run()` эти параметры будут доступны через метод `getParams()` объекта `TaskLifeCycle`.
3. На выполнения фоновых задач влияют свойства приложения xref:ui-properties.adoc#jmix.ui.background-task.task-killing-latency[jmix.ui.background-task.task-killing-latency], xref:ui-properties.adoc#jmix.ui.background-task.threads-count[jmix.ui.background-task.threads-count], и xref:ui-properties.adoc#jmix.ui.background-task.timeout-expiration-check-interval[jmix.ui.background-task.timeout-expiration-check-interval].

[[usage-example]]
== Пример использования

Часто при запуске фоновой задачи необходимо отображать простой пользовательский интерфейс:

1. Чтобы показать пользователю, что запрошенное действие выполняется.
2. Чтобы дать пользователю возможность отменить длительную операцию.
3. Чтобы отображать ход выполнения операции, если процент прогресса можно определить.

Это можно сделать с помощью метода `createBackgroundTaskDialog()` интерфейса xref:dialogs.adoc[Dialogs].

Для иллюстрации рассмотрим следующую задачу:

1. Экран содержит таблицу данных со списком пользователей с включенной множественной выборкой.
2. При щелчке на кнопке **Отправить email** система отправляет письма с напоминанием выбранным пользователям без блокировки пользовательского интерфейса и с возможностью отмены операции.

image:background-tasks/emails.png[width="842"]

[source,java,indent=0]
----
include::example$/onboarding/src/main/java/com/company/onboarding/view/backgroundtasks/BackgroundTasksView.java[tags=background-tasks-email]
----
<1> Создание задачи, создание диалога прогресса и установка его параметры:
- заголовок диалогового окна;
- текст диалога;
- общее количество элементов для индикатора прогресса;
- показывать ли прогресс в процентах или нет;
- показывать ли кнопку *Cancel* или нет.
<2> Единица прогресса задачи - это `Integer` - количество обработанных элементов таблицы, а тип результата - `Void`, потому что эта задача не возвращает результат.
<3> Выбранные элементы таблицы сохраняются в переменной, которая инициализируется в конструкторе задачи. Это необходимо, потому что метод `run()` выполняется в фоновом потоке и не имеет доступа к компонентам пользовательского интерфейса.
<4> Установка времени ожидания в 10 минут.
<5> Периодическая проверка `isCancelled()`, чтобы немедленно остановить задачу после нажатия кнопки *Cancel* в диалоговом окне.
<6> Отправка email. См. подробнее о отправке email xref:email:index.adoc[здесь].
<7> Обновление индикатора прогресса после каждой отправки email.