= UI Constraints

Дополнение UI Constraints позволяет управлять видимостью и доступностью компонентов пользовательского интерфейса с помощью декларативных политик, определенных в ресурсных ролях.

Например, кнопку можно сделать неактивной, таблицу данных скрыть и так далее.

Любой UI-компонент или xref:flow-ui:actions.adoc[действие] может управляться через UI Constraints, даже если компонент не связан с моделью данных и не зависит от операций с сущностями и xref:security:resource-roles.adoc#policies[политик атрибутов сущности]. Единственное условие — у компонента должен быть ID.

Данная функциональность избавляет от необходимости писать код для анализа ролей пользователя или конкретных разрешений и управления состоянием компонентов в экранах приложения. Она также позволяет точно настраивать управление доступом во время выполнения, редактируя роли в экранах *Security* -> *Resource roles*.

[[installation]]
== Установка

[NOTE]
====
Это дополнение требует Enterprise https://www.jmix.io/subscription-plans-and-prices/[подписки^]. Если у вас нет подписки, см. раздел xref:ROOT:account-management.adoc#enterprise-trial[Enterprise Trial], чтобы узнать, как получить пробную версию.
====

Для автоматической установки через Jmix Marketplace следуйте инструкциям в разделе xref:ROOT:add-ons.adoc#installation[Дополнения].

Для ручной установки выполните следующие шаги.

. Настройте доступ к премиум-репозиторию.
+
include::ROOT:partial$premium-repo.adoc[]

. Добавьте зависимости в `build.gradle`:
+
[source,groovy,indent=0]
----
include::example$uiconstraints-ex1/build.gradle[tags=dependencies]
----

[[usage]]
== Использование

Дополнение UI Constraints предоставляет _UI component policies_ (политики компонентов UI), которые можно указать в xref:security:resource-roles.adoc[ресурсных ролях] как на этапе разработки с использованием аннотированных Java-интерфейсов, так и во время выполнения через экраны управления ролями.

Аннотация `@UiComponentPolicy`, используемая в Java-интерфейсах, описана <<ui-component-policy-annotation,ниже>>.

Редактор ролей времени выполнения доступен через основной пункт меню *Security* -> *Resource roles*. После включения дополнения UI Constraints в проект, выпадающий список политик будет содержать элемент *UI component policy*:

image::resource-role-policies.png[align="center",width=373]

Редактор политик компонентов UI позволяет указать целевой экран, выбрать существующие компоненты из выпадающего списка и задать действие политики и эффект:

image::ui-component-policy.png[align="center",width=776]

В отличие от политик сущностей и атрибутов сущностей, политика компонентов UI является «запрещающей», то есть она может сделать компонент интерфейса или действие только менее видимыми или доступными, чем они были до применения политики. Например, если атрибут сущности виден благодаря политике атрибута сущности, политика компонента UI может сделать соответствующий компонент интерфейса невидимым, если указано действие `VISIBLE` с эффектом `DENY`. Дополнительная информация об эффектах приведена <<effect,ниже>>.

Политики компонентов UI применяются в конце процесса открытия экрана, после отправки xref:flow-ui:views/view-events.adoc#ready-event[ReadyEvent]. К этому моменту инициализация экрана завершена и другие политики применены.

[[ui-component-policy-annotation]]
== Аннотация UiComponentPolicy

Аннотация `@UiComponentPolicy` позволяет определять политики компонентов UI в интерфейсах xref:security:resource-roles.adoc[ресурсных ролей] на этапе разработки.

Пример:

[source,java,indent=0]
----
include::example$uiconstraints-ex1/src/main/java/com/company/demo/security/EmployeeRole.java[]
----

Атрибуты аннотации `@UiComponentPolicy` описаны ниже.

[[view-class-and-view-id]]
=== viewClass и viewId

Политика компонента UI определяется для компонентов внутри экрана. Экран может быть указан либо атрибутом `viewClass`, либо атрибутом `viewId`.

[[component-ids]]
=== componentIds

Каждая аннотация `@UiComponentPolicy` может определять политики для одного или нескольких компонентов экрана. Их идентификаторы должны быть перечислены в атрибуте `componentIds`. Политика может применяться к компонентам следующих типов:

* Визуальный компонент (`textField`, `button`, `vbox`, `div` и др.) на данном экране. Например: `firstNameField`, `importButton`.
* Действие, принадлежащее данному экрану. Например: `save`.
* Действие, принадлежащее компоненту экрана. Например: `userGrid.edit`.
* Компонент или действие, находящееся внутри фрагмента. Например: `addressFragment.cityField`.

[[action]]
=== action

Политика компонента UI поддерживает два типа действий:

* `VISIBLE` — управляет видимостью компонента.
* `ENABLED` — управляет доступностью компонента. Если компонент поддерживает состояние только для чтения, он будет установлен в состояние «только для чтения». В противном случае компонент будет отключен (disabled).

[[effect]]
=== effect

Атрибут `effect` может иметь два значения: `ALLOW` и `DENY`.

По умолчанию, если политики компонентов UI не применены, все UI-компоненты на экране имеют свое начальное состояние видимости и доступности. Компоненты, связанные с данными, видимы и доступны, если существует соответствующая политика атрибута сущности.

Если в политике компонента интерфейса указан эффект `DENY`, это скрывает или отключает UI-компонент или действие. Это стандартный случай использования политики компонента UI.

Эффект `ALLOW` можно использовать, если требуется переопределить эффект другой политики компонента UI, примененной к тому же компоненту другой ролью. Например, если пользователю уже назначена роль А, и эта роль запрещает доступ к определенному компоненту интерфейса, использование роли B с эффектом `ALLOW` восстановит доступ к этому компоненту.

NOTE: Эффект `ALLOW` не может отобразить или включить компонент, который был скрыт или отключен в его начальном состоянии или из-за отсутствия разрешающей политики сущности или атрибута сущности.