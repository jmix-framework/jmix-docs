= 4. Продвинутые уведомления на основе шаблонов

Прежде чем мы начнем, убедитесь, что установлено дополнение xref:notifications:index.adoc[Notifications]. Если оно еще не установлено, установите его перед продолжением.

В этом разделе вы:

* Настроите дополнение Notifications.
* Создадите шаблон в формате `Текст` с помощью дизайнера шаблонов.
* Добавите параметры в шаблон.
* Создадите уведомление, использующее этот шаблон, демонстрируя его практическое применение.

[[set-up-notifications-add-on]]
== Настройка дополнения Notifications

Подробный пример настройки дополнения Notifications можно найти в разделе xref:notifications:configuration.adoc[Конфигурация]. Здесь же мы представим краткий обзор основных шагов.

Выполните следующие действия:

. Создайте набор экземпляров `NotificationType` и зарегистрируйте их через `NotificationTypesRepository` в вашем главном классе приложения:
+
[source,java,indent=0]
----
include::../examples/messagetemplates-ex1/src/main/java/com/company/sample/MessagetemplatesEx1Application.java[tags=notificationTypesRepository;registerTypes]
----
. Добавьте компонент индикатора уведомлений в файл `main-view.xml`:
+
[source,xml,indent=0]
----
include::../examples/messagetemplates-ex1/src/main/resources/com/company/sample/view/main/main-view.xml[tags=mainView;navigationBar]
----

[[creating-message-template]]
== Создание шаблона сообщения

Запустите приложение. Перейдите в экран *Шаблоны сообщений*. Нажмите кнопку *Создать*, чтобы начать создание нового шаблона.

После нажатия на кнопку *Создать* откроется дизайнер шаблонов. Настройте шаблон следующим образом:

* *Название*: введите понятное название для шаблона, например, `Booking Notification`.
* *Код*: установите код шаблона равным `booking-notification`.
* *Тип*: выберите *Plain text* в качестве типа шаблона.
* *Содержание*: определите содержание шаблона:
+
[source,text,indent=0]
----
Hello ${booking.creator.firstName}!

Thank you for booking your date and time for ${booking.title}.
Your time starts at ${booking.startDate?datetime} and ends at ${booking.endDate?datetime}

The booking took place ${today?date}.
The penalty for false is ${penalty?string.currency}.

Have a nice day,
Developer team.

Developer
www.jmix.io
----

Этот шаблон отформатирован с использованием xref:message-templates.adoc#placeholders[плейсхолдеров] и синтаксиса шаблонизатора Apache FreeMarker.

image::template-notifications-details.png[align="center", width="775"]

[[adding-template-params]]
== Добавление параметров шаблона

Перейдите на вкладку *Параметры* в дизайнере шаблонов. Нажмите кнопку *Создать*. Укажите следующие данные параметра:

* *Название*: Название параметра, которое будет отображаться в форме ввода параметров: `Booking`.

* *Алиас параметра*: Уникальный идентификатор, используемый для ссылки на параметр в шаблоне: `booking`.

* *Тип*: Тип данных параметра. Выберите тип `Сущность`.

* *Сущность*: Выберите сущность `Booking`, которая будет использоваться в качестве параметра.

image::template-parameter.png[align="center", width="641"]

Нажмите кнопку *OK*.

Создайте параметр *Penalty*, убедившись, что он настроен как тип `Число`. Затем создайте параметр *Today* и установите для него тип `Дата`:

image::template-notifications-params.png[align="center", width="692"]

После того как шаблон настроен, сохраните его.

[[create-notification]]
== Создание уведомления

Перейдите в экран *Оповещения*. Нажмите кнопку *Создать оповещение*, чтобы начать создание нового уведомления. Настройте уведомление следующим образом:

* *Тема*: тема уведомления - `Booking information`.
* *Тип*: тип уведомления, который вы создали ранее в этом разделе. Выберите `Info`.
* *Получатели*: список получателей уведомления. Начните вводить имя пользователя в поле и выберите подходящих пользователей из списка.
* Установите флажок *Использовать шаблон сообщения*. Ниже появится поле выбора шаблона.
+
image::notification-step-1.png[align="center", width="728"]
* Нажмите кнопку *...* в поле *Шаблон сообщения*.
* Откроется диалоговое окно выбора шаблона сообщения. Выберите ранее созданный шаблон `Booking Notification` и нажмите кнопку *Выбрать*.
+
image::notification-step-2.png[align="center", width="1025"]
* После этого появится диалоговое окно с запросом на ввод значений для параметров, которые вы ранее определили для шаблона. Заполните необходимые поля соответствующими значениями. Нажмите *OK*.
+
image::notification-step-3.png[align="center", width="787"]
* После нажатия кнопки *OK* в диалоговом окне создания оповещения, уведомление будет сохранено и отображено указанному пользователю.

[[viewing-notification]]
== Просмотр уведомления

Войдите в систему как пользователь `Mari`. Найдите индикатор уведомлений, расположенный в верхнем правом углу главного экрана, и нажмите на него. Появится диалоговое окно *In-app оповещения*, отображающее список непрочитанных или последних оповещений:

image::in-app-notifications.png[align="center", width="1063"]

Дважды щелкните по уведомлению, чтобы просмотреть его полное содержание:

image::in-app-notification-open.png[align="center", width="930"]

Вы заметите, что значения параметров, которые вы указали при создании уведомления, были автоматически вставлены в соответствующие плейсхолдеры внутри шаблона сообщения, персонализируя содержание уведомления.

[[summary]]
== Резюме

В этом разделе вы успешно:

* Настроили дополнение xref:notifications:index.adoc[Notifications].
* Создали многократно используемый шаблон сообщения в формате `Текст` с помощью xref:message-templates.adoc#parameter-details[дизайнера шаблонов].
* Определили xref:message-templates.adoc#parameters[параметры] для шаблона сообщения, обеспечив динамическое содержание.
* Создали и отправили уведомление, использующее шаблон сообщения, продемонстрировав практическое применение расширенных функций уведомлений.