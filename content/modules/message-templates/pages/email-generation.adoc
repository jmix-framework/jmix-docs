= 3. Генерация email из шаблонов

Давайте рассмотрим пример генерации электронного письма на основе шаблонов темы и тела сообщения, созданных в предыдущем разделе.

Прежде чем мы начнем, убедитесь, что установлено дополнение xref:email:index.adoc[Email Sending]. Если оно еще не установлено, пожалуйста, установите его перед продолжением.

Далее настройте необходимые xref:email:configuration.adoc[параметры отправки] электронной почты, чтобы обеспечить успешную доставку писем.

[[adding-button]]
== Добавление кнопки об уведомлении

Давайте добавим кнопку *Notify by Email* в экране списка бронирований. Эта кнопка позволит пользователям отправлять уведомление по электронной почте создателю бронирования, выбранного в таблице данных.

Найдите `booking-list-view.xml` в окне инструментов *Jmix* и дважды щелкните по нему. Откроется дизайнер экранов. Выберите `action` в панели иерархии *Jmix UI* или в XML-дескрипторе. Затем нажмите кнопку *Add* на панели инспектора компонентов. В выпадающем списке выберите *Action*:

image::add-email-action.png[align="center", width="1082"]

В диалоговом окне *Add Action* выберите действие `list_itemTracking`. Действие `list_itemTracking` автоматически активируется только тогда, когда в связанной таблице данных выбран определенный элемент.

Настройте следующие атрибуты для этого действия:

[source,xml,indent=0]
----
include::../examples/messagetemplates-ex1/src/main/resources/com/company/sample/view/booking/booking-list-view.xml[tags=notify-email]
----

Затем в контейнере `buttonsPanel` добавьте кнопку и свяжите ее с вновь созданным действием.

[source,xml,indent=0]
----
include::../examples/messagetemplates-ex1/src/main/resources/com/company/sample/view/booking/booking-list-view.xml[tags=buttons-panel;notify]
----

[[generate-email]]
== Генерация email на основе шаблона

Сгенерируйте метод-обработчик события `ActionPerformedEvent` для действия `notifyEmailButton`. Добавьте в него следующую логику:

[source,java,indent=0]
----
include::../examples/messagetemplates-ex1/src/main/java/com/company/sample/view/booking/BookingListView.java[tags=booking-list-view]
----
<1> Предоставляет свойства конфигурации для шаблонизатора FreeMarker.
<2> Бин для генерации сообщений из шаблонов.
<3> Бин для отправки электронных писем.
<4> Бин для отображения уведомлений пользователю.
<5> Извлекает выбранное бронирование (`booking`) и его создателя (`creator`) из `bookingsDataGrid`.
<6> Проверяет, указан ли адрес электронной почты у создателя (`creator`) бронирования. Если нет, отображается уведомление, и метод завершает работу.
<7> Генерирует тему и тело сообщения, используя шаблоны FreeMarker (`booking-email-subject` и `booking-email-body`).
<8> Передает динамические параметры (`booking`, `today`, и `penalty`) в шаблоны.
<9> Создает объект `EmailInfo`, содержащий адрес электронной почты получателя, тему письма, тело письма и тип контента.
<10> Пытается отправить электронное письмо, используя бин `emailer`. В случае ошибки отображается уведомление о неудаче.
<11> Отображает уведомление об успехе, если электронное письмо успешно отправлено.

[[summary]]
== Резюме

В этом разделе вы узнали, как работать с шаблонами сообщений для автоматизации отправки уведомлений по электронной почте в вашем приложении.

Вы получили практический опыт добавления кнопки *Notify by Email* в экран, настройки действия для запуска процесса отправки электронной почты и написания кода для динамической генерации электронного сообщения с использованием данных из выбранной сущности.

Вы также узнали о важности установки дополнения Email Sending и настройки параметров отправки электронной почты.