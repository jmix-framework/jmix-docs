= OpenID Connect

Дополнение Jmix OpenID Connect предоставляет предопределенные конфигурации Spring Security и набор сервисов, которые позволяют легко реализовать в приложении следующие возможности:

* Аутентификация пользователя с использованием внешнего поставщика OpenID (например, Keycloak).
* Маппинг атрибутов и ролей пользователя из поставщика OpenID на пользователя Jmix.
* Сохранение сущности пользователя и назначений ролей после успешной аутентификации пользователя поставщиком OpenID.

Дополнение использует поддержку Spring Security для OAuth2 и OpenID Connect 1.0. Вы можете прочитать об этом в {spring-security-doc}/servlet/oauth2/index.html[документации Spring Security^].

Дополнение применяет конфигурацию `OidcAutoConfiguration`, если ее явно не отключить, установив свойство приложения `jmix.oidc.use-default-configuration=false`. Данная конфигурация включает аутентификацию OpenID Connect для URL пользовательского интерфейса и REST API.

[[installation]]
== Установка

Для автоматической установки через Jmix Marketplace следуйте инструкциям в разделе xref:ROOT:add-ons.adoc#installation[Add-ons].

Для ручной установки добавьте следующую зависимость в свой `build.gradle`:

[source,groovy,indent=0]
----
include::example$/oidc-ex1/build.gradle[tags=dependencies]
----

[[client-configuration]]
== Конфигурация клиента

После включения дополнения в ваш проект и перед запуском приложения необходимо настроить "клиента". Клиент - это приложение Jmix, требующее аутентификации конечных пользователей поставщиком OpenID.

Для настройки клиента используется стандартный подход Spring Security. Например, это можно сделать, добавив следующие свойства в файл `application.properties`:

[source,properties,indent=0]
----
include::example$oidc-ex1/src/main/resources/application-doc1.properties[tags=client-properties]
----

`keycloak` в ключе свойства - это идентификатор провайдера. Он может иметь любое значение, например, `okta`, тогда свойство будет `spring.security.oauth2.client.registration.okta.client-id`.

Значения идентификатора клиента (Client ID) и секрета (Client Secret) должны быть взяты из поставщика OpenID.

Свойство `issuer-uri` содержит путь к поставщику OpenID https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig[Configuration Endpoint^].

По умолчанию конфигурация дополнения будет использовать клэйм (claim) `sub` в качестве имени пользователя Jmix. Если вы хотите изменить это, используйте следующее свойство приложения:

[source,properties,indent=0]
----
include::example$oidc-ex1/src/main/resources/application-doc1.properties[tags=user-name-attribute]
----

[[using-default-addon-configuration]]
== Использование стандартной конфигурации дополнения

После включения дополнения в проект, настройки клиента и <<configuring-local-keycloak-instance,настройки Keycloak>>, приложение можно запустить. В этом случае стандартная конфигурация дополнения будет выполнять следующие действия:

* Неаутентифицированные пользователи будут перенаправлены на страницу входа поставщика OpenID.
* После того как пользователь пройдет аутентификацию поставщиком OpenID, будет создан экземпляр `DefaultJmixOidcUser` и установлен в контекст безопасности. Атрибуты пользователя не будут отображены. Пользователь не будет сохранен в базе данных.
* Коллекция кодов ролей пользователя будет взята из клэйма "roles" токена и, затем, для каждой роли из значения клэйма, ресурсная роль и роль на уровне строк будут установлены в объекте аутентификации пользователя.

Класс `DefaultJmixOidcUser` реализует интерфейс `JmixOidcUser`. Класс пользователя должен всегда реализовывать этот интерфейс, потому что Jmix-приложения требуют интерфейс `UserDetails`, а Spring Security работает с интерфейсом `OidcUser`. `JmixOidcUser` просто расширяет оба эти интерфейса.

[[mapping-user-attributes-and-roles]]
== Сопоставление атрибутов и ролей пользователя

Если вам нужно работать с пользователем в памяти, но вы хотите заполнить некоторые атрибуты пользователя, создайте класс, который расширяет `DefaultJmixOidcUser`. В приведенном ниже примере у него есть атрибут `position`:

[source,java,indent=0]
----
include::example$/oidc-ex1/src/main/java/examples/oidcex1/entity/MyUser.java[tags=my-user]
----

Затем вам нужно зарегистрировать экземпляр `OidcUserMapper` как бин Spring. Вы можете расширить `BaseOidcUserMapper` и переопределить его методы:

[source,java,indent=0]
----
include::example$oidc-ex1/src/main/java/examples/oidcex1/mapper/MyOidcUserMapper.java[tags=code]
----

Обратите внимание, что в приведенном выше примере сопоставление клэймов из пользователя OIDC в Jmix granted authorities делегируется интерфейсу `ClaimsRolesMapper`. Реализация `ClaimsRolesMapper` по умолчанию - это `DefaultClaimsRolesMapper`, который получает клэйм с именем "roles" из токена ID. Этот клэйм должен содержать коллекцию имен ролей. Затем для каждой роли из значения клэйма будут искаться ресурсная роль и роль уровня строк в Jmix. Если они найдены, соответствующие granted authorities будут добавлены пользователю. Имя клэйма ролей можно настроить, используя следующее свойство приложения:

[source,properties,indent=0]
----
jmix.oidc.default-claims-roles-mapper.roles-claim-name=myRoles
----

При необходимости вы можете создать свой маппер клэймов в роли. Самый простой способ сделать это - расширить `BaseClaimsRolesMapper` и переопределить его методы `getResourceRolesCodes()` и/или `getRowLevelRolesCodes()`. Приведенный ниже пример демонстрирует, как назначать роли на основе клэйма "position":

[source,java,indent=0]
----
include::example$oidc-ex1/src/main/java/examples/oidcex1/mapper/MyClaimsRoleMapper.java[tags=code]
----

[[working-with-user-jpa-entity]]
== Работа с JPA-сущностью пользователя

Для работы с дополнением Jmix OIDC, JPA-сущность `User` должна реализовывать интерфейс `io.jmix.oidc.user.JmixOidcUser`, который, в свою очередь, реализует `org.springframework.security.oauth2.core.oidc.user.OidcUser`, требуемый Spring Security.

Простейший способ сделать сущность `User` совместимой с дополнением OIDC - сделать этот класс подклассом абстрактного класса `io.jmix.oidc.user.JmixOidcUserEntity`:

[source,java,indent=0]
----
include::example$oidc-ex1/src/main/java/examples/oidcex1/entity/User.java[tags=jpa-user-entity-start;jpa-user-entity-end]
----
[NOTE]
====
В случае проекта на Kotlin необходимо сделать дополнительные изменения в сущности `User`:

* Добавить аннотацию `@get:JvmName("getEmail_")` на свойство `email`.
* Добавить метод `override fun getEmail(): String? = email`
====
Чтобы сохранять пользователей в базе данных после их входа с использованием поставщика OpenID, вам нужно зарегистрировать маппер пользователя, который расширяет класс `SynchronizingOidcUserMapper`. Этот суперкласс содержит поведение, которое сохраняет/обновляет пользователя в базе данных. При желании, вы также можете сохранять в базе данных и информацию о назначениях ролей.

[source,java,indent=0]
----
include::example$oidc-ex1/src/main/java/examples/oidcex1/mapper/MySynchronizingOidcUserMapper.java[tags=code;!profile]
----

[[protecting-api]]
== Защита API

Приложение Jmix может работать как сервер ресурсов. Чтобы указать, какой авторизационный сервер использовать, определите следующее свойство приложения:

[source,properties,indent=0]
----
spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8180/realms/<realm>
----

Значение свойства - это URL, содержащийся в клэйме `iss` для JWT-токенов, которые авторизационный сервер будет выдавать. См. {spring-security-doc}/servlet/oauth2/resource-server/jwt.html#_specifying_the_authorization_server[документацию Spring Security^] для получения дополнительной информации.

По умолчанию значение клэйма `sub` используется в качестве имени пользователя Jmix, который устанавливается в контекст безопасности. Если вы хотите изменить это, используйте следующее свойство приложения:

[source,properties,indent=0]
----
jmix.oidc.jwt-authentication-converter.username-claim=preferred_username
----

В большинстве случаев значение свойства должно согласовываться со значением свойства `spring.security.oauth2.client.provider.keycloak.user-name-attribute`.

Токены доступа, полученные от поставщика OpenID, могут использоваться для доступа к защищенным конечным точкам, предоставляемым дополнением REST API.

Для локального экземпляра Keycloak токены доступа можно получить следующим образом:

[source,shell,indent=0]
----
curl -X POST http://localhost:8180/realms/sample1/protocol/openid-connect/token \
--user <client-id>:<client-secret> \
-H "Content-Type: application/x-www-form-urlencoded" \
-d "grant_type=password&scope=openid&username=<username>&password=<password>"
----

Например:

[source,shell,indent=0]
----
curl -X POST http://localhost:8180/realms/sample1/protocol/openid-connect/token \
--user jmix-app:UONXQZf6unxVuWsxXvhMAPv5IxFz5P7D \
-H "Content-Type: application/x-www-form-urlencoded" \
-d "grant_type=password&&scope=openid&username=johndoe&password=mypass"
----

Теперь рассмотрим, как защитить собственные контроллеры MVC, например следующий:

[source,java,indent=0]
----
include::example$oidc-ex1/src/main/java/examples/oidcex1/controller/GreetingController.java[tags=code]
----

Представьте, что вам нужно защитить все URL, начинающиеся с `/authenticated/`, и сделать все URL, начинающиеся с `/anonymous/`, доступными для анонимного доступа. Это можно сделать xref:security:custom-endpoints.adoc#token-based-authentication[несколькими способами]. Простейший подход - использовать свойства приложения:

[source,properties]
----
include::example$oidc-ex1/src/main/resources/application-resserver.properties[tags=resource-server-endpoints-security]
----

[[oidc-properties]]
== Свойства OIDC

[[jmix.oidc.use-default-configuration]]
=== jmix.oidc.use-default-configuration

Определяет, применять ли конфигурацию по умолчанию. По умолчанию установлено значение true. Установите это свойство в false, если вы хотите иметь доступ к бинам и интерфейсам дополнения, но не хотите использовать предварительно определенную конфигурацию Spring Security для защиты конечных точек. В этом случае вам придется написать свою собственную конфигурацию безопасности.

[source,properties]
----
jmix.oidc.use-default-configuration = false
----

[[jmix.oidc.default-claims-roles-mapper.roles-claim-name]]
=== jmix.oidc.default-claims-roles-mapper.roles-claim-name

Определяет имя клэйма в токене ID, которое содержит коллекцию названий ролей. Это свойство используется классом `DefaultClaimsRolesMapper`. Значение по умолчанию - `roles`.

[source,properties]
----
jmix.oidc.default-claims-roles-mapper.roles-claim-name = myRoles
----

[[configuring-local-keycloak-instance]]
== Настройка локального экземпляра Keycloak

Один из самых популярных поставщиков OpenID - https://www.keycloak.org/[Keycloak^]. Для ознакомления с дополнением Jmix OIDC вы можете запустить Keycloak локально с помощью Docker.

[[starting-keycloak-using-docker]]
=== Запуск Keycloak с использованием Docker

Используйте следующую команду для запуска экземпляра Keycloak с помощью Docker на порту 8180:

[source,shell,indent=0]
----
docker run -p 8180:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin --name keycloak quay.io/keycloak/keycloak:22.0 start-dev
----

См. https://www.keycloak.org/getting-started/getting-started-docker[документацию Keycloak^] для получения дополнительной информации.

URL Keycloak: http://localhost:8180[^]

Административные учетные данные:
[source,text]
----
Имя пользователя: admin
Пароль: admin
----

Вы можете прочитать о настройке экземпляра Keycloak в https://www.keycloak.org/docs/latest/server_admin/[Руководстве администратора сервера^].

[[creating-a-realm]]
=== Создание Realm

Войдите в консоль администратора Keycloak.

Откройте выпадающее окно вверху левой панели.

Нажмите **Create Realm**.

image::keycloak/create_realm_1.png[align="center"]

Дайте имя новому Realm, например, "sample".

image::keycloak/create_realm_2.png[align="center"]

[[creating-client]]
=== Создание клиента

Чтобы подключить приложение Jmix к Keycloak, вам нужно создать нового клиента **jmix-app** с типом клиента **OpenID Connect**.

image::keycloak/create_client_1.png[align="center"]

Включите **Client authentication**.

image::keycloak/create_client_2.png[align="center"]

Введите **Valid redirect URIs**:

[source,text]
----
http://localhost:8080/*
----

и **Web origins**:

[source,text]
----
http://localhost:8080
----

image::keycloak/create_client_3.png[align="center"]

Откройте только что созданный клиент и перейдите на вкладку **Credentials**. Там отображается **Client secret**, который вам понадобится в проекте Jmix для настройки подключения.

image::keycloak/client_credentials.png[align="center"]

Параметры клиента должны использоваться в файле `application.properties`. См. раздел <<client-configuration,Настройка клиента>>.

[[creating-role]]
=== Создание роли

Затем вам следует создать новую роль в Realm. По умолчанию имя роли должно совпадать с кодом роли Jmix. Создайте роль **system-full-access**:

image::keycloak/create_role.png[align="center"]

[[creating-user]]
=== Создание пользователя

Создайте пользователя с именем пользователя **johndoe**:

image::keycloak/create_user.png[align="center"]

После сохранения пользователя появится вкладка **Credentials**. Там вы можете установить пароль пользователя.

image::keycloak/create_user_credentials.png[align="center"]

На вкладке **Role mappings** назначьте роль **system-full-access**:

image::keycloak/assign_role.png[align="center"]

Если вы хотите заполнить атрибуты пользователя (например, "должность"), то можете сделать это на вкладке **Attributes** в редакторе пользователя.

[[creating-roles-mapper]]
=== Создание маппера ролей

Чтобы вернуть информацию о ролях Realm в токене ID, вам нужно определить маппер для клиента **jmix-app**. Откройте редактор клиента и перейдите на вкладку **Client scopes**:

image::keycloak/create_mapper_1.png[align="center"]

Откройте редактор области **jmix-app-dedicated**. Добавьте предопределенный маппер для "realm roles":

image::keycloak/create_mapper_2.png[align="center"]

Откройте только что созданный маппер "realm roles" Измените значение атрибута **Token Claim Name** на `roles` и выберите флажок **Add to userinfo**. Таким образом вы указываете, что клэйм, содержащий список ролей пользователя, будет называться `roles`.

image::keycloak/create_mapper_3.png[align="center"]
