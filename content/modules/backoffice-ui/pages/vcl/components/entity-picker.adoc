= EntityPicker

++++
<div class="backoffice-ui-live-demo-container">
    <a href="https://demo.jmix.io/sampler/#main/sample?id=entitypicker-simple" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

`EntityPicker` позволяет отображать экземпляр xref:data-model:entities.adoc[сущности] в текстовом поле и выполнять действия нажатием пользователя на кнопку справа.

XML-имя компонента: `entityPicker`.

== Основы

Используйте `EntityPicker`, если:

* Значение поля является ссылкой на экземпляр сущности.
* Пользователям нужно выбрать или создать экземпляр сущности с помощью экрана выбора или ввести определенное значение.
* Пользователям нужно открыть экран редактирования для связанного экземпляра сущности.

По умолчанию Jmix Studio генерирует `EntityPicker` при создании экрана редактора сущности со ссылочным атрибутом.

image::vcl/components/entity-picker1.png[align="center"]

В следующем примере экран определяет контейнер данных `orderDc` для сущности `Order`, имеющей атрибут `customer`. В элементе `entityPicker` атрибут `dataContainer` содержит ссылку на контейнер данных `orderDc`, а атрибут `property` ссылается на атрибут сущности `customer`. Этот атрибут должен быть ссылкой на сущность. В следующем примере это `Customer`.

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/entitypicker/entityPicker-screen.xml[tags=data;entityPicker;vbox-layout-end]
----

[WARNING]
====
Для правильной работы `EntityPicker` необходимо либо задать атрибут `metaClass`, либо одновременно задать атрибуты `dataContainer` и `property`.
====

[[actions]]
== Действия

Для `EntityPicker` можно определить настраиваемые и предопределенные действия, отображаемые в виде кнопок справа. Это можно сделать либо в XML-дескрипторе с помощью вложенного элемента `actions`, либо программно в контроллере с помощью метода `addAction()`.

[[predefined-actions]]
=== Предопределенные действия

Когда Studio генерирует `EntityPicker` в экране редактора, она также генерирует два предопределенных стандартных действия: `entity_lookup` и `entity_clear`. Существуют также действия `entity_open` и `entity_openComposition`.

Используйте атрибуты `type` и `id` для объявления предопределенных действий в XML.

Если создать `EntityPicker` без действий, загрузчик XML определит для него только действия `entity_lookup` и `entity_clear`. Чтобы добавить другое предопределенное действие, например, `entity_open`, нужно определить элемент `actions` следующим образом:

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/entitypicker/entityPicker-screen.xml[tags=entityPicker3actions]
----

Элемент `actions` не дополняет, а переопределяет набор стандартных действий. Вам необходимо явно указывать идентификаторы всех требуемых действий.

[[custom-actions]]
=== Настраиваемые действия

Чтобы определить настраиваемое действие в XML, используйте вложенный элемент `actions`. Укажите для `action` атрибуты `id` и `icon`:

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/entitypicker/entityPicker-screen.xml[tags=customAction]
----

Затем реализуйте кастомную логику в контроллере экрана, подписавшись на `Action.ActionPerformedEvent`:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitypicker/EntityPickerScreen.java[tags=customerEntityPicker;customAction]
----

<1> Аннотация `@Subscribe` содержит `EntityPicker` `id` и `id` действия, разделенные точкой.

[TIP]
====
Заглушку реализации слушателя `Action.ActionPerformedEvent` можно генерировать с помощью Studio.
====

[[add-actions-programmatically]]
=== Программное добавление действий

Используйте метод `addAction()` для программного задания действий.

* *Добавление стандартного действия*
+
Например, если компонент определен в XML-дескрипторе без вложенного элемента `actions`, то достаточно добавить недостающие стандартные действия:
+
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitypicker/EntityPickerScreen.java[tags=addAction;on-init-start;addAction2;on-init-end]
----

* *Добавление настраиваемых действий*
+
Пример создания настраиваемого действия:
+
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitypicker/EntityPickerScreen.java[tags=inject-customerEp;on-init-start;add-custom-action;on-init-end]
----

[[meta-class]]
== metaClass

Компонент `EntityPicker` можно использовать без непосредственной привязки к данным, то есть без указания `dataContainer` и `property`. В этом случае для указания типа сущности, с которой должен работать `EntityPicker`, используется атрибут `metaClass`.

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/entitypicker/entityPicker-screen.xml[tags=metaclass]
----

Экземпляр выбранной сущности можно получить, инжектировав компонент в контроллер и вызвав его метод `getValue()`.

[[icons]]
== Установка значков

Компонент `EntityPicker` может иметь значок слева. Просто установите `fieldIconProvider` в контроллере экрана для реализации кастомной логики:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitypicker/EntityPickerScreen.java[tags=fieldIconProvider]
----

<1> Реализация делегирующего метода `fieldIconProvider`.

image::vcl/components/entity-picker-icons.png[align="center"]

См. xref:icons.adoc[Значки], чтобы найти больше информации о работе со значками.

Чтобы создать провайдера иконок поля программно, используйте метод компонента `setFieldIconProvider()`.

[[fieldEditable]]
== Ввод текстового значения

По умолчанию пользователь не может ввести значение вручную. Если задать для атрибута `fieldEditable` значение `true`, ручной ввод будет включен. Это может быть удобно для создания экземпляра сущности на основе значения, введенного пользователем.

Keep in mind that the entered value is not set to the data model. To handle user input, use the `FieldValueChangeEvent`.

Рассмотрим приведенный ниже пример. Дана сущность `Address` с атрибутом `country`, ссылающимся на сущность `Country`. Сущность `Country` имеет только один атрибут `name`. Определим `countryField` в XML-дескрипторе с помощью `fieldEditable="true"`:

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/entity/address/address-edit.xml[tags=fieldEditable]
----

Теперь пользователь может ввести значение вручную. Для обработки этого значения как строкового, подпишитесь на `FieldValueChangeEvent` в контроллере:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/entity/address/AddressEdit.java[tags=field-value-change]
----

<1> Аннотация `@Subscribe` содержит id `EntityPicker`.
<2> Получение введенного значения из объекта события.
<3> Создание новый экземпляр сущности `Country`.
<4> Установка созданного экземпляра полю.

Чтобы создать слушателя события программно, используйте метод компонента `addFieldValueChangeListener()`.

[[programmatically-creating]]
== Программное создание EntityPicker

Чтобы создать `EntityPicker` в контроллере, используйте фабрику `UiComponents`. Учитывайте, что созданный программно `EntityPicker` не будет иметь действий по умолчанию, необходимые действия нужно определить явно:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitypicker/EntityPickerScreen.java[tags=userPicker1;on-init-start;userPicker3]
----

[[handlers]]
== События и слушатели

include::../events-hanlers-generation-tip.adoc[]

[[context-help-icon-click-handler]]
=== ContextHelpIconClickHandler

См. xref:vcl/api.adoc#context-help-icon-click-handler[ContextHelpIconClickHandler].

[[field-icon-provider]]
=== FieldIconProvider

См. <<icons,Setting Icons>>.

[[field-value-change-event]]
=== FieldValueChangeEvent

`FieldValueChangeEvent` отправляется, когда пользователь вручную вводит значение.

Для получения дополнительной информации см. <<fieldEditable>>.

[[formatter]]
=== Formatter

Добавляет экземпляр xref:vcl/miscellaneous/formatter.adoc[formatter] в компонент.

В приведенном ниже примере показано использование `formatter` для `customerFormat`:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitypicker/EntityPickerScreen.java[tags=formatter]
----

Чтобы добавить formatter программно, используйте метод компонента `addFormatter()`.

[[validator]]
=== Validator

См. xref:vcl/components/combo-box.adoc#validator[Validator].

[[value-change-event]]
=== ValueChangeEvent

См. xref:vcl/api.adoc#value-change-event[ValueChangeEvent].

[[xml]]
== XML-атрибуты EntityPicker

include::../xml-studio-tip.adoc[]

xref:vcl/xml.adoc#align[align] -
xref:vcl/xml.adoc#buffered[buffered] -
xref:vcl/xml.adoc#caption[caption] -
xref:vcl/xml.adoc#caption-as-html[captionAsHtml] -
xref:vcl/xml.adoc#colspan[colspan] -
xref:vcl/xml.adoc#context-help-text[contextHelpText] -
xref:vcl/xml.adoc#context-help-text-html-enabled[contextHelpTextHtmlEnabled] -
xref:vcl/xml.adoc#css[css] -
xref:vcl/xml.adoc#data-container[dataContainer] -
xref:vcl/xml.adoc#description[description] -
xref:vcl/xml.adoc#description-as-html[descriptionAsHtml] -
xref:vcl/xml.adoc#editable[editable] -
xref:vcl/xml.adoc#enable[enable] -
xref:vcl/xml.adoc#box-expand-ratio[box.expandRatio] -
<<fieldEditable,fieldEditable>> -
xref:vcl/xml.adoc#height[height] -
xref:vcl/xml.adoc#html-sanitizer-enabled[htmlSanitizerEnabled] -
xref:vcl/xml.adoc#icon[icon] -
xref:vcl/xml.adoc#id[id] -
<<meta-class,metaClass>> -
xref:vcl/xml.adoc#property[property] -
xref:vcl/xml.adoc#required[required] -
xref:vcl/xml.adoc#required-message[requiredMessage] -
xref:vcl/xml.adoc#stylename[stylename] -
xref:vcl/xml.adoc#tab-index[tabIndex] -
xref:vcl/xml.adoc#visible[visible] -
xref:vcl/xml.adoc#width[width]

== XML-элементы EntityPicker

<<actions,actions>> -
xref:vcl/miscellaneous/formatter.adoc[formatter] -
xref:vcl/components/entity-combo-box.adoc#validators-element[validators]